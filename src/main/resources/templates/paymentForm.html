<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Toss Payments SDK 로드 -->
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BookDuck² :: 결제</title>
    <style>
        /* 필요한 스타일 추가 */
        body { font-family: sans-serif; padding: 20px; }
        form label { display: block; margin-bottom: 8px; }
        form input[type="text"], form input[type="number"] {
            width: 250px;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        form button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        form button:hover {
            background-color: #0056b3;
        }
        .error-message { color: red; font-weight: bold; margin-bottom: 15px; }
    </style>
</head>
<body>

<h2>결제 정보 입력</h2>

<!-- 서버에서 전달된 결제 오류 메시지 표시 -->
<div th:if="${paymentError}" class="error-message" th:text="${paymentError}"></div>
<div th:if="${errorMessage}" class="error-message" th:text="${errorMessage}"></div>

<!-- 세션에 로그인 사용자 정보가 없을 경우 메시지 표시 -->
<div th:if="${session.loginuser == null}">
    <p>결제를 진행하려면 로그인이 필요합니다.</p>
    <!-- 로그인 페이지로 이동하는 링크 등 추가 가능 -->
</div>

<!-- 로그인 상태일 때만 결제 폼 표시 -->
<form id="payment-form" th:if="${session.loginuser != null}">
    <label>상품명:
        <input type="text" id="product-name" readonly required th:value="${productName}" style="background-color: #eee;">
        <!-- 상품명은 수정 불가능하게 readonly 처리 -->
    </label>
    <label>가격(원):
        <input type="number" id="amount" readonly required th:value="${amount}" style="background-color: #eee;">
        <!-- 가격은 수정 불가능하게 readonly 처리 -->
    </label>
    <label>구매자 이름:
        <input type="text" id="customer-name" required th:value="${session.loginuser.nickName}" value="구매자명 기본값">
        <!-- 구매자 이름은 필요시 수정 가능하게 둘 수 있음 -->
    </label>

    <!-- 사용자 ID와 ISBN을 위한 숨겨진 필드 -->
    <input type="hidden" id="userId" name="userId" th:value="${session.loginuser.id}" />
    <input type="hidden" id="isbn" name="isbn" th:value="${isbn}" /> <!-- 컨트롤러에서 전달된 isbn 값 -->

    <button type="submit" id="payment-button">결제하기</button>
</form>

<!-- ====================================================== -->
<!--          JavaScript 코드 (로그인 상태일 때만 실행)         -->
<!-- ====================================================== -->
<script th:inline="javascript" th:if="${session.loginuser != null}">
    /*<![CDATA[*/

    // 중요: 실제 서비스에서는 발급받은 Client Key 사용
    const clientKey = "test_ck_ma60RZblrqomEqDaE0WM3wzYWBn1"; // 테스트 키
    const tossPayments = TossPayments(clientKey);
    const paymentButton = document.getElementById("payment-button");

    document.getElementById("payment-form").addEventListener("submit", function (e) {
        e.preventDefault(); // 폼 기본 제출 방지

        // 결제 버튼 비활성화 (중복 요청 방지)
        paymentButton.disabled = true;
        paymentButton.textContent = "결제 처리 중...";

        // 폼에서 값 가져오기
        const productName = document.getElementById("product-name").value;
        const amountInput = document.getElementById("amount");
        const amount = parseInt(amountInput.value); // 정수로 변환
        const customerName = document.getElementById("customer-name").value;
        const userId = document.getElementById("userId").value;
        // ★★★ 숨겨진 필드에서 ISBN 값 가져오기 ★★★
        const isbn = document.getElementById("isbn").value;

        // 금액 유효성 검사
        if (isNaN(amount) || amount <= 0) {
            alert("결제 금액이 유효하지 않습니다.");
            paymentButton.disabled = false; // 버튼 다시 활성화
            paymentButton.textContent = "결제하기";
            return;
        }

        // 고유한 주문 ID 생성 (충분히 고유하게 생성하는 방식 권장)
        const orderId = "order-" + new Date().getTime() + "-" + Math.random().toString(36).substring(2, 8);

        // === Success URL 구성 ===
        // 기본 URL (현재 서버 주소 기준 상대 경로 또는 절대 경로 사용 가능)
        // 주의: localhost는 개발 환경에서만 유효. 배포 시 실제 도메인/주소 사용해야 함.
        const baseUrl = window.location.origin; // 예: http://localhost:8081

        // Toss Payments가 자동으로 추가할 파라미터 외에 필요한 파라미터(userId, isbn) 추가
        let successUrl = `${baseUrl}/payment/success?userId=${encodeURIComponent(userId)}`;
        successUrl += `&orderName=${encodeURIComponent(productName)}`; // ★ 상품명 추가
        successUrl += `&customerName=${encodeURIComponent(customerName)}`; // ★ 구매자 이름 추가

        // ★★★ ISBN 값이 유효하면 successUrl에 추가 ★★★
        if (isbn && isbn !== 'ISBN 정보 없음' && isbn.trim() !== '') {
            successUrl += `&isbn=${encodeURIComponent(isbn)}`;
        } else {
            console.warn("ISBN value is missing or invalid. It will not be added to the success URL.");
            // ISBN이 없을 때의 처리 (예: 컨트롤러에서 required=false로 받고 null 처리)
        }

        // === Fail URL 구성 ===
        const failUrl = `${baseUrl}/payment/fail?orderId=${orderId}`; // 실패 시에도 주문 ID는 전달

        console.log("Requesting payment with data:", { amount, orderId, orderName: productName, customerName, userId, isbn });
        console.log("Calculated Success URL:", successUrl); // ★★★ 전송될 Success URL 확인 ★★★
        console.log("Calculated Fail URL:", failUrl);

        // === Toss Payments 결제 요청 ===
        tossPayments.requestPayment("카드", { // "카드", "가상계좌", "계좌이체" 등 결제수단 지정
            amount: amount,              // 결제 금액
            orderId: orderId,            // 주문 ID
            orderName: productName,      // 주문명
            customerName: customerName,  // 구매자 이름
            successUrl: successUrl,      // ★★★ 성공 시 리디렉션될 URL (userId, isbn 포함) ★★★
            failUrl: failUrl,            // 실패 시 리디렉션될 URL
            // customerEmail: "customer@example.com", // 구매자 이메일 (선택)
            // customerMobilePhone: "01012345678",   // 구매자 휴대폰 번호 (선택, 가상계좌 등에서 필요)
            // customerKey: userId // Toss Payments 고객 식별 기능 사용 시 (선택)
        }).then(function (response) {
            // 성공 로직은 successUrl 리디렉션 후 서버에서 처리하므로 여기서는 특별히 할 일 없음
            console.log("Payment request successful, redirecting to success URL...", response);
            // 결제 창이 닫히고 successUrl로 이동됨
        }).catch(function (error) {
            console.error("Toss Payments Error:", error);
            paymentButton.disabled = false; // 오류 발생 시 버튼 다시 활성화
            paymentButton.textContent = "결제하기";

            if (error.code === "USER_CANCEL") {
                alert("결제를 취소했습니다.");
            } else if (error.code === "INVALID_CARD_NUMBER") {
                alert("카드 번호가 유효하지 않습니다.");
            } else if (error.code === "INVALID_ORDER_NAME") {
                alert("주문명이 너무 길거나 유효하지 않습니다.");
            }
            // 기타 다양한 오류 코드 처리 가능
            else {
                alert("결제 중 오류가 발생했습니다: " + (error.message || "알 수 없는 오류"));
            }
        });
    });

    /*]]>*/
</script>

</body>
</html>