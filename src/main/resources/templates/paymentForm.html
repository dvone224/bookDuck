<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Toss Payments SDK 로드 -->
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BookDuck² :: 결제하기</title> <!-- 타이틀 업데이트 -->
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
        h2 { text-align: center; margin-bottom: 20px; }
        form { border: 1px solid #eee; padding: 20px; border-radius: 8px; background-color: #fafafa; }
        form label { display: block; margin-bottom: 8px; font-weight: bold; color: #555;}
        form input[type="text"], form input[type="number"] {
            width: calc(100% - 18px); padding: 8px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px;
        }
        form input[readonly] { background-color: #eee; cursor: not-allowed; }
        form button {
            padding: 10px 20px; color: white; border: none; border-radius: 4px;
            cursor: pointer; font-size: 1rem; margin-right: 10px; transition: background-color 0.2s;
        }
        form button:hover:not(:disabled) { opacity: 0.9; }
        #payment-button { background-color: #007bff; }
        #payment-button:hover:not(:disabled) { background-color: #0056b3; }
        #add-to-cart-button { background-color: #28a745; }
        #add-to-cart-button:hover:not(:disabled) { background-color: #218838; }
        form button:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.6; }
        .message-box { margin-bottom: 15px; padding: 10px; border-radius: 4px; border: 1px solid; }
        .error-message { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
        /* .owned-message 스타일은 JavaScript에서 필요시 동적으로 추가 가능 */
        .button-group { margin-top: 15px; }
    </style>
</head>
<body>

<h2>상품 정보</h2>

<!-- 서버 메시지 표시 -->
<div th:if="${paymentError}" class="message-box error-message" th:text="${paymentError}"></div>
<div th:if="${errorMessage}" class="message-box error-message" th:text="${errorMessage}"></div>

<!-- 로그인 필요 메시지 -->
<div th:if="${session.loginuser == null}">
    <p>결제하거나 장바구니에 담으려면 <a href="/login-form">로그인</a>이 필요합니다.</p>
</div>

<!-- 로그인 상태일 때 폼 표시 -->
<div th:if="${session.loginuser != null}">
    <form id="payment-form">
        <label for="product-name">상품명:</label>
        <input type="text" id="product-name" readonly required th:value="${productName}">

        <label for="amount">가격(원):</label>
        <input type="number" id="amount" readonly required th:value="${amount}">

        <label for="customer-name">구매자 이름:</label>
        <input type="text" id="customer-name" required th:value="${session.loginuser.nickName}">

        <input type="hidden" id="userId" name="userId" th:value="${session.loginuser.id}" />
        <input type="hidden" id="isbn" name="isbn" th:value="${isbn}" /> <!-- String ISBN 값 -->

        <!-- 버튼 그룹 -->
        <div class="button-group">
            <!-- ✨ Thymeleaf 소유 여부 관련 코드 제거 ✨ -->
            <button type="button" id="payment-button">결제하기</button> <!-- 기본 활성화 -->
            <button type="button" id="add-to-cart-button">장바구니 담기</button>
        </div>
    </form>
</div>

<!-- JavaScript (로그인 상태일 때만 포함) -->
<script th:inline="javascript" th:if="${session.loginuser != null}">
    /*<![CDATA[*/
    const clientKey = "test_ck_ma60RZblrqomEqDaE0WM3wzYWBn1"; // ★★ 실제 키로 변경 ★★
    const tossPayments = TossPayments(clientKey);
    const paymentButton = document.getElementById("payment-button");
    const addToCartButton = document.getElementById("add-to-cart-button");

    // --- ✨ 결제하기 버튼 클릭 리스너 (비동기 소유 확인 로직) ✨ ---
    paymentButton.addEventListener("click", async function (e) { // async 추가
        e.preventDefault();

        if (paymentButton.disabled) { return; } // 중복 클릭 방지

        const userId = document.getElementById("userId").value;
        const isbn = document.getElementById("isbn").value; // String ISBN

        if (!userId || !isbn || isbn === 'ISBN 정보 없음' || isbn.trim() === '') { alert("결제 정보 부족."); return; }

        let bookId; // Long 타입 Book ID
        try { bookId = parseInt(isbn.trim(), 10); if (isNaN(bookId)) throw new Error(); }
        catch (error) { alert("도서 정보(ISBN) 형식 오류."); return; }

        paymentButton.disabled = true;
        paymentButton.textContent = "소유 확인 중...";

        // --- 비동기 소유 여부 확인 ---
        try {
            // ✨ API 호출 경로 수정: /payment/check-ownership ✨
            const checkResponse = await fetch(`/payment/check-ownership?bookId=${bookId}`); // API 호출

            if (!checkResponse.ok) {
                const errorData = await checkResponse.json().catch(() => ({ error: "서버 확인 응답 오류" }));
                throw new Error(errorData.error || `소유 확인 실패 (${checkResponse.status})`);
            }
            const data = await checkResponse.json();

            if (data.isOwned === true) { // ✨ 소유 중 처리 ✨
                alert("이미 소장 중인 상품입니다.");
                paymentButton.disabled = false; paymentButton.textContent = "결제하기"; return; // 중단
            }
            console.log("소유하지 않음 확인. 결제 진행.");

        } catch (error) { // API 호출 오류 처리
            console.error("소유 확인 오류:", error);
            alert("소유 여부 확인 중 오류: " + error.message);
            paymentButton.disabled = false; paymentButton.textContent = "결제하기"; return; // 중단
        }
        // --- 소유 여부 확인 끝 ---

        // --- 결제 로직 시작 ---
        paymentButton.textContent = "결제 처리 중...";

        const productName = document.getElementById("product-name").value;
        const amount = parseInt(document.getElementById("amount").value);
        const customerName = document.getElementById("customer-name").value;

        if (isNaN(amount) || amount <= 0) { /* 금액 오류 처리 */ alert("결제 금액 오류."); paymentButton.disabled = false; paymentButton.textContent = "결제하기"; return; }

        const orderId = "order-" + new Date().getTime() + "-" + Math.random().toString(36).substring(2, 8);
        const baseUrl = window.location.origin;
        // Success/Fail URL 경로는 /payment/success, /payment/fail 유지
        let successUrl = `${baseUrl}/payment/success?userId=${encodeURIComponent(userId)}&orderName=${encodeURIComponent(productName)}&customerName=${encodeURIComponent(customerName)}&isbn=${encodeURIComponent(isbn)}`;
        const failUrl = `${baseUrl}/payment/fail?orderId=${orderId}`;

        console.log("Requesting payment...", { amount, orderId, orderName: productName, customerName, userId, isbn });

        // Toss Payments 결제 요청
        tossPayments.requestPayment("카드", { amount, orderId, orderName: productName, customerName, successUrl, failUrl })
            .then(res => console.log("Payment redirecting...", res))
            .catch(err => {
                console.error("Toss Error:", err);
                paymentButton.disabled = false; paymentButton.textContent = "결제하기";
                if (err.code === "USER_CANCEL") alert("결제 취소됨.");
                else alert("결제 오류: " + (err.message || "알 수 없는 오류"));
            });
    });

    // --- 장바구니 담기 로직 (변경 없음) ---
    addToCartButton.addEventListener("click", function() {
        const userId = document.getElementById("userId").value; const isbn = document.getElementById("isbn").value;
        if (!userId || !isbn || isbn === 'ISBN 정보 없음' || isbn.trim() === '') { alert("장바구니 정보 누락"); return; }
        try { parseInt(isbn.trim(), 10); } catch(e) { alert("유효하지 않은 도서 정보"); return; }
        addToCartButton.disabled = true; addToCartButton.textContent = "담는 중...";
        const formData = new FormData(); formData.append('userId', userId); formData.append('bookId', isbn);
        fetch('/cart', { method: 'POST', body: formData }) // POST /cart 로 요청
            .then(response => { if (response.ok) { alert('장바구니 담기 성공!'); } else { response.json().then(data => alert('실패: '+(data.message||'서버 오류'))).catch(()=>response.text().then(text=>alert('실패: '+(text||'서버 오류')))); }})
            .catch(error => { console.error('Error:', error); alert('오류 발생'); })
            .finally(() => { addToCartButton.disabled = false; addToCartButton.textContent = "장바구니 담기"; });
    });

    /*]]>*/
</script>

</body>
</html>