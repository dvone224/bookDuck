<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>결제 페이지</title>
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <meta charset="UTF-8">
</head>
<body>

<h2>결제 정보 입력</h2>

<div th:if="${paymentError}" style="color: red; font-weight: bold;" th:text="${paymentError}"></div>

<form id="payment-form">
    <label>상품명: <input type="text" id="product-name" required th:value="${productName}"></label><br><br>
    <label>가격(원): <input type="number" id="amount" required th:value="${amount}"></label><br><br>
    <label>구매자 이름: <input type="text" id="customer-name" value="홍길동" required></label><br><br>
    <!-- ISBN 숨겨진 필드 제거 -->
    <!-- <input type="hidden" id="isbn" th:value="${isbn}"> -->

    <button type="submit">결제하기</button>
</form>

<script th:inline="javascript">
    /*<![CDATA[*/

    const clientKey = "test_ck_ma60RZblrqomEqDaE0WM3wzYWBn1";
    const tossPayments = TossPayments(clientKey);

    document.getElementById("payment-form").addEventListener("submit", function (e) {
        e.preventDefault();

        const productName = document.getElementById("product-name").value;
        const amountInput = document.getElementById("amount");
        const amount = parseInt(amountInput.value);
        const customerName = document.getElementById("customer-name").value;
        // const isbn = document.getElementById("isbn").value; 제거

        if (isNaN(amount) || amount <= 0) {
            alert("유효한 가격을 입력해주세요.");
            amountInput.focus();
            return;
        }

        const orderId = "order-" + Math.random().toString(36).substring(2, 12);

        // successUrl 에서 isbn 파라미터 제거
        const successUrl = `http://localhost:8081/payment/success?orderId=${orderId}&orderName=${encodeURIComponent(productName)}&customerName=${encodeURIComponent(customerName)}&amount=${amount}`;
        const failUrl = "http://localhost:8081/payment/fail";

        console.log("Requesting payment with:", { amount, orderId, orderName: productName, customerName, successUrl, failUrl });

        tossPayments.requestPayment("카드", {
            amount: amount,
            orderId: orderId,
            orderName: productName,
            customerName: customerName,
            successUrl: successUrl,
            failUrl: failUrl
        }).catch(function (error) {
            console.error("Toss Payments Error:", error);
            if (error.code === "USER_CANCEL") {
                alert("결제를 취소했습니다.");
            } else if (error.code === "INVALID_ORDER_NAME") {
                alert("주문명이 유효하지 않습니다.");
            } else {
                alert("결제 에러 발생: " + (error.message || "알 수 없는 오류"));
            }
        });
    });

    /*]]>*/
</script>

</body>
</html>