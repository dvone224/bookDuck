<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BookDuck²::CREW 생성</title>
    <style>
        body { font-family: sans-serif; }
        .form-container { max-width: 600px; margin: 20px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="search"] { width: calc(100% - 18px); padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem;}
        input:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25); }
        .error-message { color: red; font-size: 0.875em; margin-top: 4px; min-height: 1.2em; display: block; }
        #search-results-container, #book-search-results-container { position: relative; }
        #searchResults, #bookSearchResults { position: absolute; width: calc(100% - 2px); border: 1px solid #ccc; border-top: none; max-height: 150px; overflow-y: auto; background-color: white; list-style: none; padding: 0; margin: -1px 0 0 0; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: none; border-bottom-left-radius: 4px; border-bottom-right-radius: 4px; }
        #searchResults li, #bookSearchResults li { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.95em; }
        #searchResults li:last-child, #bookSearchResults li:last-child { border-bottom: none; }
        #searchResults li:hover, #bookSearchResults li:hover { background-color: #f0f0f0; }
        #searchResults li.no-results, #bookSearchResults li.no-results { cursor: default; color: #777; }
        #selectedUsersContainer, #selectedBookContainer { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; border: 1px solid #eee; min-height: 40px; border-radius: 4px; margin-top: 5px; background-color: #f9f9f9; }
        .selected-user-tag, .selected-book-tag { display: inline-flex; align-items: center; background-color: #e0e0e0; padding: 4px 8px; border-radius: 12px; font-size: 0.875em; }
        .selected-user-tag.is-me { background-color: #cce5ff; font-weight: bold; }
        .selected-user-tag .user-nickname, .selected-book-tag .book-title { margin-right: 6px; }
        .selected-user-tag .remove-user, .selected-book-tag .remove-book { display: flex; align-items: center; justify-content: center; width: 16px; height: 16px; cursor: pointer; font-weight: bold; color: #555; border: none; background-color: #c0c0c0; border-radius: 50%; padding: 0; font-size: 12px; line-height: 1; margin-left: 4px; transition: background-color 0.2s, color 0.2s; }
        .selected-user-tag .remove-user:hover, .selected-book-tag .remove-book:hover { background-color: #a0a0a0; color: #fff; }
        .action-buttons { text-align: center; margin-top: 25px; }
        button[type="submit"] { padding: 10px 25px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 1rem; transition: background-color 0.2s; }
        button[type="submit"]:hover:not(:disabled) { background-color: #0056b3; }
        button[type="submit"]:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; }
    </style>
</head>
<body>

<!-- 로그인 사용자 정보 -->
<input type="hidden" id="loggedInUserId" th:value="${session.loginuser?.id}" />
<input type="hidden" id="loggedInUserNickname" th:value="${session.loginuser?.nickName}" />

<div class="form-container">
    <h1>새 그룹 생성</h1>

    <form id="createGroupForm" th:action="@{/group/create}" method="post">

        <!-- 1. 그룹 이름 입력 -->
        <div class="form-group">
            <label for="groupNameInput">그룹 이름:</label>
            <input type="text" id="groupNameInput" name="groupName" placeholder="그룹 이름을 입력하세요" required autocomplete="off">
            <span id="groupNameError" class="error-message"></span>
        </div>

        <!-- 2. 사용자 검색 및 선택 -->
        <div class="form-group">
            <label for="userSearchInput">멤버 추가 (본인 제외 <span id="min-members-label">1</span>명 ~ <span id="max-members-label">3</span>명):</label>
            <div id="search-results-container">
                <input type="search" id="userSearchInput" placeholder="초대할 사용자 닉네임 검색 (예: 오리)" autocomplete="off">
                <ul id="searchResults"></ul>
            </div>
        </div>

        <!-- 3. 선택된 사용자 목록 표시 -->
        <div class="form-group">
            <label>선택된 멤버:</label>
            <div id="selectedUsersContainer"></div>
            <div id="hiddenMemberIdsContainer" style="display: none;"></div>
            <span id="memberErrorMessage" class="error-message"></span>
        </div>

        <!-- 4. 책 검색 및 선택 -->
        <div class="form-group">
            <label for="bookSearchInput">책 선택 (1권):</label>
            <div id="book-search-results-container">
                <input type="search" id="bookSearchInput" placeholder="소유한 책 제목 검색 (예: 책 제목)" autocomplete="off">
                <ul id="bookSearchResults"></ul>
            </div>
        </div>

        <!-- 5. 선택된 책 표시 -->
        <div class="form-group">
            <label>선택된 책:</label>
            <div id="selectedBookContainer"></div>
            <input type="hidden" id="hiddenBookId" name="bookId">
            <span id="bookErrorMessage" class="error-message"></span>
        </div>

        <!-- 6. 그룹 생성 버튼 -->
        <div class="action-buttons">
            <button type="submit" id="submitButton" disabled>그룹 생성</button>
        </div>

    </form>
</div>

<script th:inline="javascript">
    // 요소 가져오기
    const searchInput = document.getElementById('userSearchInput');
    const searchResults = document.getElementById('searchResults');
    const selectedUsersContainer = document.getElementById('selectedUsersContainer');
    const hiddenMemberIdsContainer = document.getElementById('hiddenMemberIdsContainer');
    const groupNameInput = document.getElementById('groupNameInput');
    const groupNameError = document.getElementById('groupNameError');
    const createGroupForm = document.getElementById('createGroupForm');
    const submitButton = document.getElementById('submitButton');
    const memberErrorMessageDiv = document.getElementById('memberErrorMessage');
    const loggedInUserIdInput = document.getElementById('loggedInUserId');
    const loggedInUserNicknameInput = document.getElementById('loggedInUserNickname');
    const minMembersLabel = document.getElementById('min-members-label');
    const maxMembersLabel = document.getElementById('max-members-label');
    const bookSearchInput = document.getElementById('bookSearchInput');
    const bookSearchResults = document.getElementById('bookSearchResults');
    const selectedBookContainer = document.getElementById('selectedBookContainer');
    const hiddenBookIdInput = document.getElementById('hiddenBookId');
    const bookErrorMessageDiv = document.getElementById('bookErrorMessage');

    // 상태 변수
    let selectedUsers = new Map();
    let selectedBook = null;
    const loggedInUserId = loggedInUserIdInput ? loggedInUserIdInput.value : null;
    const loggedInUserNickname = loggedInUserNicknameInput ? loggedInUserNicknameInput.value : '나';
    let MIN_SELECTED_MEMBERS_EXCL_OWNER = 1;
    let MAX_SELECTED_MEMBERS_EXCL_OWNER = 3;
    let isGroupNameAvailable = false;
    let isCheckingGroupName = false;
    let groupNameCheckTimeout;
    let userSearchTimeout;
    let bookSearchTimeout;

    // 백엔드 엔드포인트
    const USER_SEARCH_URL = /*[[@{/user/search}]]*/ '/user/search';
    const BOOK_SEARCH_URL = /*[[@{/book/search}]]*/ '/book/search';
    const GROUP_NAME_CHECK_URL = /*[[@{/group/check-name}]]*/ '/group/check-name';

    // 이벤트 리스너
    groupNameInput.addEventListener('input', () => {
        clearTimeout(groupNameCheckTimeout);
        const groupName = groupNameInput.value.trim();
        isGroupNameAvailable = false;
        groupNameError.textContent = '';
        isCheckingGroupName = false;

        if (groupName.length > 0 && loggedInUserId) {
            groupNameError.textContent = '확인 중...';
            groupNameError.style.color = '#777';
            isCheckingGroupName = true;
            validateForm();

            groupNameCheckTimeout = setTimeout(() => {
                checkGroupNameAvailability(groupName);
            }, 500);
        } else {
            validateForm();
        }
    });

    searchInput.addEventListener('input', () => {
        clearTimeout(userSearchTimeout);
        const query = searchInput.value.trim();
        searchResults.style.display = 'none';

        if (query.length > 0 && loggedInUserId) {
            userSearchTimeout = setTimeout(() => {
                fetchUsers(query);
            }, 300);
        } else {
            clearSearchResults();
        }
    });

    searchResults.addEventListener('click', (event) => {
        const targetLi = event.target.closest('li');
        if (targetLi && targetLi.dataset.userId) {
            const userId = targetLi.dataset.userId;
            const userNickname = targetLi.dataset.userNickname;

            if (userId === loggedInUserId) return;
            if (selectedUsers.has(userId)) {
                showMemberError('이미 선택된 사용자입니다.');
                searchInput.focus();
                return;
            }
            const addedMemberCount = selectedUsers.size - (loggedInUserId && selectedUsers.has(loggedInUserId) ? 1 : 0);
            if (addedMemberCount >= MAX_SELECTED_MEMBERS_EXCL_OWNER) {
                showMemberError(`멤버는 본인 제외 최대 ${MAX_SELECTED_MEMBERS_EXCL_OWNER}명까지만 추가할 수 있습니다.`);
                searchInput.value = '';
                clearSearchResults();
                return;
            }

            addSelectedUser(userId, userNickname);
            searchInput.value = '';
            clearSearchResults();
            searchInput.focus();
            validateForm();
        }
    });

    selectedUsersContainer.addEventListener('click', (event) => {
        if (event.target.classList.contains('remove-user') && event.target.dataset.userId !== loggedInUserId) {
            const userId = event.target.dataset.userId;
            removeSelectedUser(userId);
            validateForm();
        }
    });

    bookSearchInput.addEventListener('input', () => {
        clearTimeout(bookSearchTimeout);
        const query = bookSearchInput.value.trim();
        bookSearchResults.style.display = 'none';

        if (query.length > 0 && loggedInUserId) {
            bookSearchTimeout = setTimeout(() => {
                fetchBooks(query);
            }, 300);
        } else {
            clearBookSearchResults();
        }
    });

    bookSearchResults.addEventListener('click', (event) => {
        const targetLi = event.target.closest('li');
        if (targetLi && targetLi.dataset.bookId) {
            const bookId = targetLi.dataset.bookId;
            const bookTitle = targetLi.dataset.bookTitle;

            if (selectedBook && selectedBook.id === bookId) return;

            addSelectedBook(bookId, bookTitle);
            bookSearchInput.value = '';
            clearBookSearchResults();
            bookSearchInput.focus();
            validateForm();
        }
    });

    selectedBookContainer.addEventListener('click', (event) => {
        if (event.target.classList.contains('remove-book')) {
            removeSelectedBook();
            validateForm();
        }
    });

    createGroupForm.addEventListener('submit', (event) => {
        if (submitButton.disabled) {
            event.preventDefault();
            validateForm();
            return false;
        }
        clearMemberError();
        clearGroupNameError();
        clearBookError();
        submitButton.textContent = '생성 중...';
        submitButton.disabled = true;
    });

    document.addEventListener('click', (event) => {
        const isClickInsideUserSearch = searchInput.contains(event.target) || searchResults.contains(event.target);
        const isClickInsideBookSearch = bookSearchInput.contains(event.target) || bookSearchResults.contains(event.target);
        if (!isClickInsideUserSearch) clearSearchResults();
        if (!isClickInsideBookSearch) clearBookSearchResults();
    });

    // 함수들
    function initializeLoggedInUser() {
        if (loggedInUserId && loggedInUserNickname) {
            selectedUsers.set(loggedInUserId, loggedInUserNickname);
            const tag = document.createElement('span');
            tag.classList.add('selected-user-tag', 'is-me');
            tag.dataset.userId = loggedInUserId;
            const nameSpan = document.createElement('span');
            nameSpan.classList.add('user-nickname');
            nameSpan.textContent = `${loggedInUserNickname} (나)`;
            tag.appendChild(nameSpan);
            selectedUsersContainer.appendChild(tag);

            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'memberIds';
            hiddenInput.value = loggedInUserId;
            hiddenInput.id = `hidden-user-${loggedInUserId}`;
            hiddenMemberIdsContainer.appendChild(hiddenInput);
        } else {
            console.warn("로그인 사용자 정보를 찾을 수 없습니다.");
            groupNameInput.disabled = true;
            searchInput.disabled = true;
            bookSearchInput.disabled = true;
            submitButton.disabled = true;
            showGroupNameError("그룹을 생성하려면 로그인이 필요합니다.");
        }
    }

    async function checkGroupNameAvailability(name) {
        isCheckingGroupName = true;
        groupNameError.textContent = '확인 중...';
        groupNameError.style.color = '#777';
        validateForm();

        try {
            const checkUrl = `${GROUP_NAME_CHECK_URL}?name=${encodeURIComponent(name)}`;
            const response = await fetch(checkUrl);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            isGroupNameAvailable = data.isAvailable;
            if (!isGroupNameAvailable) {
                showGroupNameError('이미 사용 중인 그룹 이름입니다.');
            } else {
                clearGroupNameError();
            }
        } catch (error) {
            console.error('Error checking group name:', error);
            isGroupNameAvailable = false;
            showGroupNameError('이름 확인 중 오류 발생. 다시 시도해주세요.');
        } finally {
            isCheckingGroupName = false;
            validateForm();
        }
    }

    async function fetchUsers(query) {
        const searchUrl = `${USER_SEARCH_URL}?name=${encodeURIComponent(query)}&limit=8`;
        try {
            const response = await fetch(searchUrl);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            const users = await response.json();
            displaySearchResults(users);
        } catch (error) {
            console.error('Error fetching users:', error);
            displaySearchResults(null, '사용자 검색 중 오류 발생. 다시 시도해주세요.');
        }
    }

    function displaySearchResults(users, errorMessage = null) {
        searchResults.innerHTML = '';
        if (errorMessage) {
            const li = document.createElement('li');
            li.textContent = errorMessage;
            li.classList.add('no-results');
            searchResults.appendChild(li);
        } else if (users && users.length > 0) {
            let hasResultsToShow = false;
            users.forEach(user => {
                if (String(user.id) === loggedInUserId) return;
                if (!selectedUsers.has(String(user.id))) {
                    const li = document.createElement('li');
                    li.textContent = user.nickName;
                    li.dataset.userId = user.id;
                    li.dataset.userNickname = user.nickName;
                    searchResults.appendChild(li);
                    hasResultsToShow = true;
                }
            });
            if (!hasResultsToShow) {
                const li = document.createElement('li');
                li.textContent = '추가할 사용자가 없거나 이미 선택했습니다.';
                li.classList.add('no-results');
                searchResults.appendChild(li);
            }
        } else {
            const li = document.createElement('li');
            li.textContent = '검색 결과가 없습니다.';
            li.classList.add('no-results');
            searchResults.appendChild(li);
        }
        searchResults.style.display = 'block';
    }

    function clearSearchResults() {
        searchResults.innerHTML = '';
        searchResults.style.display = 'none';
    }

    async function fetchBooks(query) {
        const searchUrl = `${BOOK_SEARCH_URL}?title=${encodeURIComponent(query)}&limit=8`;
        try {
            const response = await fetch(searchUrl);
            if (!response.ok) {
                if (response.status === 401) {
                    throw new Error('로그인이 필요합니다.');
                } else if (response.status === 404) {
                    throw new Error('사용자 정보를 찾을 수 없습니다.');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            }
            const books = await response.json();
            displayBookSearchResults(books);
        } catch (error) {
            console.error('Error fetching books:', error);
            displayBookSearchResults(null, error.message || '책 검색 중 오류 발생. 다시 시도해주세요.');
        }
    }

    function displayBookSearchResults(books, errorMessage = null) {
        bookSearchResults.innerHTML = '';
        if (errorMessage) {
            const li = document.createElement('li');
            li.textContent = errorMessage;
            li.classList.add('no-results');
            bookSearchResults.appendChild(li);
        } else if (books && books.length > 0) {
            books.forEach(book => {
                const li = document.createElement('li');
                li.textContent = book.title;
                li.dataset.bookId = book.id;
                li.dataset.bookTitle = book.title;
                bookSearchResults.appendChild(li);
            });
        } else {
            const li = document.createElement('li');
            li.textContent = '소유한 책이 없거나 검색 결과가 없습니다.';
            li.classList.add('no-results');
            bookSearchResults.appendChild(li);
        }
        bookSearchResults.style.display = 'block';
    }

    function clearBookSearchResults() {
        bookSearchResults.innerHTML = '';
        bookSearchResults.style.display = 'none';
    }

    function addSelectedUser(userId, userNickname) {
        if (userId === loggedInUserId || selectedUsers.has(userId)) return;
        selectedUsers.set(userId, userNickname);
        const tag = document.createElement('span');
        tag.classList.add('selected-user-tag');
        tag.dataset.userId = userId;
        const nameSpan = document.createElement('span');
        nameSpan.classList.add('user-nickname');
        nameSpan.textContent = userNickname;
        const removeBtn = document.createElement('button');
        removeBtn.classList.add('remove-user');
        removeBtn.type = 'button';
        removeBtn.textContent = '×';
        removeBtn.dataset.userId = userId;
        removeBtn.setAttribute('aria-label', `${userNickname} 제거`);
        tag.appendChild(nameSpan);
        tag.appendChild(removeBtn);
        selectedUsersContainer.appendChild(tag);
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'memberIds';
        hiddenInput.value = userId;
        hiddenInput.id = `hidden-user-${userId}`;
        hiddenMemberIdsContainer.appendChild(hiddenInput);
        clearMemberError();
    }

    function removeSelectedUser(userId) {
        if (userId === loggedInUserId || !selectedUsers.has(userId)) return;
        selectedUsers.delete(userId);
        const tagToRemove = selectedUsersContainer.querySelector(`.selected-user-tag[data-user-id="${userId}"]`);
        if (tagToRemove) selectedUsersContainer.removeChild(tagToRemove);
        const hiddenInputToRemove = hiddenMemberIdsContainer.querySelector(`#hidden-user-${userId}`);
        if (hiddenInputToRemove) hiddenMemberIdsContainer.removeChild(hiddenInputToRemove);
        clearMemberError();
        validateForm();
    }

    function addSelectedBook(bookId, bookTitle) {
        selectedBook = { id: bookId, title: bookTitle };
        selectedBookContainer.innerHTML = '';
        const tag = document.createElement('span');
        tag.classList.add('selected-book-tag');
        tag.dataset.bookId = bookId;
        const titleSpan = document.createElement('span');
        titleSpan.classList.add('book-title');
        titleSpan.textContent = bookTitle;
        const removeBtn = document.createElement('button');
        removeBtn.classList.add('remove-book');
        removeBtn.type = 'button';
        removeBtn.textContent = '×';
        removeBtn.setAttribute('aria-label', `${bookTitle} 제거`);
        tag.appendChild(titleSpan);
        tag.appendChild(removeBtn);
        selectedBookContainer.appendChild(tag);
        hiddenBookIdInput.value = bookId;
        clearBookError();
    }

    function removeSelectedBook() {
        selectedBook = null;
        selectedBookContainer.innerHTML = '';
        hiddenBookIdInput.value = '';
        clearBookError();
    }

    function validateForm() {
        if (!loggedInUserId) {
            submitButton.disabled = true;
            return false;
        }
        const addedMemberCount = selectedUsers.size - (selectedUsers.has(loggedInUserId) ? 1 : 0);
        const groupNameValue = groupNameInput.value.trim();
        const isGroupNameEntered = groupNameValue.length > 0;
        const isMemberCountValid = addedMemberCount >= MIN_SELECTED_MEMBERS_EXCL_OWNER && addedMemberCount <= MAX_SELECTED_MEMBERS_EXCL_OWNER;
        const isGroupNameReady = isGroupNameEntered && !isCheckingGroupName && isGroupNameAvailable;
        const isBookSelected = !!selectedBook;
        const isFormValid = isGroupNameReady && isMemberCountValid && isBookSelected;
        submitButton.disabled = !isFormValid;

        if (isGroupNameEntered && isGroupNameReady) {
            if (addedMemberCount < MIN_SELECTED_MEMBERS_EXCL_OWNER) {
                showMemberError(`멤버를 본인 제외 ${MIN_SELECTED_MEMBERS_EXCL_OWNER}명 이상 선택해주세요.`);
            } else if (addedMemberCount > MAX_SELECTED_MEMBERS_EXCL_OWNER) {
                showMemberError(`멤버는 본인 제외 최대 ${MAX_SELECTED_MEMBERS_EXCL_OWNER}명까지 선택 가능합니다.`);
            } else {
                clearMemberError();
            }
            if (!isBookSelected) {
                showBookError('책을 1권 선택해주세요.');
            } else {
                clearBookError();
            }
        } else {
            clearMemberError();
            clearBookError();
        }

        if (!isGroupNameEntered && groupNameInput.hasAttribute('required')) {
        } else if (isGroupNameEntered && !isCheckingGroupName && !isGroupNameAvailable && !groupNameError.textContent) {
            showGroupNameError('이미 사용 중인 그룹 이름이거나 사용할 수 없습니다.');
        } else if (!isGroupNameEntered) {
            clearGroupNameError();
        }

        return isFormValid;
    }

    function showGroupNameError(message) {
        groupNameError.textContent = message;
        groupNameError.style.color = 'red';
    }
    function clearGroupNameError() {
        groupNameError.textContent = '';
    }
    function showMemberError(message) {
        memberErrorMessageDiv.textContent = message;
        memberErrorMessageDiv.style.color = 'red';
    }
    function clearMemberError() {
        memberErrorMessageDiv.textContent = '';
    }
    function showBookError(message) {
        bookErrorMessageDiv.textContent = message;
        bookErrorMessageDiv.style.color = 'red';
    }
    function clearBookError() {
        bookErrorMessageDiv.textContent = '';
    }

    function initializePage() {
        initializeLoggedInUser();
        const initialGroupName = groupNameInput.value.trim();
        if (initialGroupName && loggedInUserId) {
            checkGroupNameAvailability(initialGroupName);
        } else {
            validateForm();
        }
    }
    initializePage();
</script>
</body>
</html>