<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
    <script src="https://kit.fontawesome.com/116a85af51.js" crossorigin="anonymous"></script>
    <title th:text="'BookDuck² :: ' + (${group} ? ${group.name} : '그룹') + ' 정보 수정'">CREW 정보 수정</title>
    <style>
        /* === CSS 수정본 (가로 정렬 보장 및 버튼 아이콘 수정) === */

        /* 아이콘 임포트 및 폰트 정의 (기존 유지) */
        @import url('https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css');
        @font-face { font-family: 'Cafe24Supermagic-Bold-v1.0'; src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2307-2@1.0/Cafe24Supermagic-Bold-v1.0.woff2') format('woff2'); font-weight: 700; font-style: normal; }
        @font-face { font-family: 'GowunBatang-Regular'; src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2108@1.1/GowunBatang-Regular.woff') format('woff'); font-weight: normal; font-style: normal; }
        /* (다른 폰트 정의 생략 없이 유지) */
        @font-face { font-family: 'GowunDodum-Regular'; src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2108@1.1/GowunDodum-Regular.woff') format('woff'); font-weight: normal; font-style: normal; }
        @font-face { font-family: 'ChosunGu'; src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_20-04@1.0/ChosunGu.woff') format('woff'); font-weight: normal; font-style: normal; }
        @font-face { font-family: 'Ownglyph_corncorn-Rg'; src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/2412-1@1.0/Ownglyph_corncorn-Rg.woff2') format('woff2'); font-weight: normal; font-style: normal; }
        @import url('//fonts.googleapis.com/earlyaccess/nanumpenscript.css');
        @font-face { font-family: 'TTHakgyoansimKkokkomaR'; src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2402_keris@1.0/TTHakgyoansimKkokkomaR.woff2') format('woff2'); font-weight: normal; font-style: normal; }
        @font-face { font-family: 'SimKyungha'; src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2202-2@1.0/SimKyungha.woff') format('woff'); font-weight: normal; font-style: normal; }
        @font-face { font-family: 'EarlyFontDiary'; src: url('https://gcore.jsdelivr.net/gh/projectnoonnu/noonfonts_220508@1.0/EarlyFontDiary.woff2') format('woff2'); font-weight: normal; font-style: normal; }


        /* 컬러 파레트 및 CSS 변수 (기존 유지) */
        :root{
            --main-color-dark: #00479B; --main-color-middle: #83C7FF; --main-color-light: #E3F4FF;
            --assist-color-dark: #CE7000; --assist-color-middle: #FFB90B; --assist-color-light: #FFF7E6;
            --cancle-color-dark: #9B9B9B; --cancle-color-middle: #D3D3D3; --cancle-color-light: #EAEAEA;
            --crown-color: #ffa500;
            --border-big: 20px; --border-middle: 10px; --border-circle: 50%;
            --font-size-0: 28px; --font-size-1: 23px; --font-size-2: 18px; --font-size-3: 13px; --font-size-4: 8px;
            /* (메모 색상 변수 생략 없이 유지) */
        }

        /* Global 스타일 초기화 (기존 유지) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Gowun Batang", sans-serif; font-size: var(--font-size-2); }
        body { margin: 0; padding: 0; width: 100%; display: flex; flex-direction: column; align-items: center; background: var(--main-color-light); }

        /* 컨테이너 스타일 (기존 유지) */
        .container { width: 100%; max-width: 768px; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        header{ width: 100%; max-width: 768px; }

        /* 버튼 기본 규격 (기존 유지) */
        .btn_circle{ width: 45px; height: 45px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; margin: 10px; border: none; background-color: transparent; }
        .btn_circle .btn_icon{ width: 25px; height: 25px; cursor: pointer; }
        .btn_circle .btn_icon_color{ width: 35px; height: 35px; cursor: pointer; }
        .btn_long{ width: 100%; height: 45px; border-radius: 45px; color: white; cursor: pointer; border: none; font-weight: bold; max-width: 768px; }
        .btn_mini{ width: auto; height: 25px; border-radius: 20px; color: white; cursor: pointer; border: none; font-size: var(--font-size-3); font-weight: bold; display: flex; justify-content: center; align-items: center; padding: 0 15px; margin-left: 5px; }

        /* 박스 및 타이틀 (기존 유지) */
        .box{ width: 100%; border-radius: var(--border-big); display: flex; flex-direction: column; align-items: center; padding: 20px; margin-bottom: 15px; max-width: 768px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .title{ display: flex; flex-direction: column; align-items: center; margin-bottom: 15px; font-weight: bold; width: 100%; }
        .title label { display: block; font-size: var(--font-size-1); margin-bottom: 8px; color: var(--main-color-dark); }
        .underline{ width: 80px; height: 2px; margin-top: 5px; background: var(--main-color-dark); }
        .line{ width: 100%; height: 1px; background-color: var(--cancle-color-light); }

        /* 색상 클래스 (기존 유지) */
        .blue{ background: var(--main-color-middle); } .blue2{ color: var(--main-color-middle); }
        .yellow{ background: var(--assist-color-middle); }
        .dark_blue1{ background: var(--main-color-dark); } .dark_yellow1{ background: var(--assist-color-dark); }
        .dark_blue2{ color: var(--main-color-dark); } .dark_yellow2{ color: var(--assist-color-dark); }
        .light_blue{ background: var(--main-color-light); box-shadow: none; border: 1px solid var(--main-color-middle); }
        .light_yellow{ background: var(--assist-color-light); box-shadow: none; border: 1px solid var(--assist-color-middle); }
        .gray{ background: var(--cancle-color-middle); } .gray2{ color: var(--cancle-color-middle); }
        .white{ background: white; } .white2{ color: white; }

        /* 입력 필드 (기존 유지) */
        .input_long{ width: 100%; height: 45px; border-radius: 25px; box-sizing: border-box; text-align: left; padding: 0 20px; max-width: 768px; margin-bottom: 15px; font-size: var(--font-size-2); }
        .blue_line{ border: 1px solid var(--main-color-middle); color: var(--main-color-dark); }
        .blue_line:focus{ border: 2px solid var(--main-color-dark); outline: none; }
        .yellow_line{ border: 1px solid var(--assist-color-middle); color: var(--assist-color-dark); }
        .yellow_line:focus{ border: 2px solid var(--assist-color-dark); outline: none; }

        /* 에러/성공 메시지 (기존 유지) */
        .error-message, .success-message { padding: 10px 15px; margin-bottom: 20px; border-radius: 4px; text-align: center; font-size: 0.95em; width: 100%; max-width: 768px;}
        .error-message { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .success-message { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }

        /* 폼 그룹 (기존 유지) */
        .form-group{ width: 100%; display: flex; flex-direction: column; align-items: center; margin-bottom: 15px; }
        .form-group label:not(:empty) { display: block; margin-bottom: 8px; font-weight: bold; color: var(--main-color-dark); }

        /* 멤버 목록 (기존 유지) */
        .member-list{ width: 100%; display: flex; justify-content: center; align-items: flex-start; flex-wrap: wrap; gap: 15px; padding: 10px 0; list-style: none; margin: 0; }
        .member_one{ width: 80px; height: auto; display: flex; flex-direction: column; align-items: center; margin: 0 5px; }
        .member_img_box{ width: 70px; height: 70px; position: relative; margin-bottom: 5px; }
        .member_img{ border: 3px solid var(--main-color-middle); background: var(--main-color-light); width: 100%; height: 100%; border-radius: 50%; overflow: hidden; }
        .member_img img { width: 100%; height: 100%; object-fit: cover; }
        .member_img_box .btn_circle_mini { width: 24px; height: 24px; font-size: 12px; position: absolute; bottom: 0; right: 0; background: var(--assist-color-middle); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 1px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .member_name{ height: auto; text-align: center; margin-top: 3px; }
        .member_name>span{ font-size: var(--font-size-3); font-weight: normal; color: var(--main-color-dark); }

        /* 책 관련 섹션 (기존 유지) */
        .book-section { width: 100%; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--main-color-middle); }

        /* 그룹 도서 목록 (가로 정렬 및 간격 보장) */
        .group-book-list-container { /* ★ 새로운 래퍼 추가 */
            width: 100%;
            background-color: white;
            border-radius: var(--border-big);
            padding: 20px; /* 내부 여백 */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-top: 10px; /* 위 요소와의 간격 */
        }
        .group-book-list { /* ★ 내부 ul 역할 */
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start; /* 왼쪽 정렬 */
            gap: 15px; /* 아이템 간 간격 */
            list-style: none;
            padding: 0; /* 내부 패딩 제거 (컨테이너에서 처리) */
            margin: 0;
        }
        .group-book-item {
            width: calc(33.333% - 10px); /* 3열, gap 15px 기준 */
            min-height: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #fff; /* 아이템 배경은 흰색 유지 */
            border: 1px solid #eee;
            border-radius: var(--border-middle);
            padding: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: relative; /* 버튼 위치 기준 */
            box-sizing: border-box;
            overflow: hidden;
        }
        .box_img_btn {
            width: 100%;
            height: 170px;
            position: relative;
            margin-bottom: 10px; /* 제목과의 간격 */
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f8f8f8;
            border-radius: 5px;
            overflow: hidden;
        }
        .box_img_btn img.select_book_img {
            display: block;
            width: auto;
            height: 100%;
            max-width: 100%;
            object-fit: contain;
        }
        .select_book_title {
            font-size: var(--font-size-3);
            color: var(--main-color-dark);
            text-align: center;
            width: 100%;
            padding: 0 5px; /* 좌우 약간의 패딩 */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 2.6em;
            line-height: 1.3em;
            margin-top: auto; /* 아래로 밀기 */
        }

        /* 버튼 위치 (오른쪽 상단) */
        .toggle-privacy-btn {
            position: absolute;
            top: 8px;
            left: 8px; /* 왼쪽 상단 */
            z-index: 10;
            width: 28px; height: 28px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            border: none; cursor: pointer; transition: background-color 0.3s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .toggle-privacy-btn.is-public { background-color: var(--assist-color-middle); }
        .toggle-privacy-btn.is-private { background-color: var(--cancle-color-middle); }

        .delete-book-btn {
            position: absolute;
            top: 8px;
            right: 8px; /* 오른쪽 상단 */
            z-index: 10;
            width: 28px; height: 28px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            border: none; cursor: pointer; background-color: #dc3545;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        /* 아이콘 스타일 */
        .toggle-privacy-btn i, .delete-book-btn i {
            font-size: 14px; color: white; line-height: 1; /* 추가: 아이콘 세로 정렬 */
        }
        /* 버튼 비활성화 시 */
        .toggle-privacy-btn:disabled, .delete-book-btn:disabled {
            opacity: 0.5; cursor: not-allowed;
        }

        /* 책 검색 (기존 유지) */
        .book-search-container { position: relative; width: 100%; }
        #bookSearchResults { position: absolute; top: 100%; left: 0; right: 0; background-color: white; border: 1px solid #ccc; border-top: none; max-height: 200px; overflow-y: auto; list-style: none; padding: 0; margin: 0; z-index: 100; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 0 0 4px 4px; display: none; box-sizing: border-box; }
        #bookSearchResults li { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f0f0f0; }
        #bookSearchResults li:last-child { border-bottom: none; }
        #bookSearchResults li:hover { background-color: #f0f0f0; }
        #bookSearchResults img { max-width: 30px; height: auto; flex-shrink: 0; border-radius: 2px; }
        #bookSearchResults span { font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-check-result { font-size: 0.85em; color: red; display: block; margin-top: -5px; margin-bottom: 10px; font-weight: normal; text-align: center; }

        /* 선택된 추가할 책 표시 (스타일 조정) */
        #selectedBookDisplay { display: flex; align-items: center; gap: 10px; background-color: var(--assist-color-light); border: 1px solid var(--assist-color-middle); padding: 8px 12px; border-radius: 4px; margin-top: 10px; width: 100%; }
        #selectedBookDisplay img { max-width: 30px; height: auto; border-radius: 2px; }
        #selectedBookDisplay span { font-size: 0.9em; color: var(--assist-color-dark); flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #cancelAddBook { margin-left: auto; background: none; border: none; color: var(--assist-color-dark); cursor: pointer; font-size: 1.3em; padding: 0 5px; line-height: 1; opacity: 0.7; transition: opacity 0.2s; }
        #cancelAddBook:hover { opacity: 1; }

        /* 이름 중복 확인 (기존 유지) */
        .name-check-result { font-size: 0.85em; margin-top: 5px; font-weight: normal; display: block; text-align: center; height: 1.2em; }
        .name-available { color: green; }
        .name-unavailable { color: red; }
        #groupName:disabled { background-color: #eee; cursor: not-allowed; }

        /* 제출 버튼 (기존 유지) */
        .submit-button { display: block; width: 100%; padding: 12px; background-color: var(--main-color-middle); color: white; border: none; border-radius: 25px; font-size: var(--font-size-1); font-weight: bold; cursor: pointer; transition: background-color 0.2s ease, box-shadow 0.2s ease; margin-top: 30px; }
        .submit-button:hover { background-color: var(--main-color-dark); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .submit-button:disabled { background-color: #cccccc; cursor: not-allowed; box-shadow: none; }

        /* 메시지 박스 (기존 유지) */
        .no-books-message { color: #888; font-style: italic; margin: 15px 0; text-align: center; width: 100%; }
        .read-only-info.error { color: red; }
        .under_margin{ margin-bottom: 10px; }
        .error_box{ width: 100%; margin-top: 20px; }
        .error_box .error { margin-bottom: 15px; }

        /* 미디어 쿼리 (반응형 간격/열 조정) */
        @media screen and (max-width: 768px) {
            .container, header { width: 100%; padding: 10px; }
            .group-book-list-container { padding: 15px; } /* 컨테이너 패딩 */
            .group-book-list { gap: 10px; } /* 아이템 간격 */
            .group-book-item { width: calc(50% - 5px); /* 2열, gap 10px 기준 */ }
        }
        @media screen and (max-width: 480px) {
            .container { padding: 5px; font-size: 14px; }
            .group-book-list-container { padding: 10px; }
            .group-book-list { gap: 10px; }
            .group-book-item { width: calc(50% - 5px); min-height: 230px; /* 높이 조정 */ }
            .member_one { width: 70px; margin: 0 5px; }
            .member_img_box { width: 60px; height: 60px; }
            .input_long { padding: 0 15px; }
            .submit-button { font-size: var(--font-size-2); }
            .title label { font-size: var(--font-size-2); }
        }

    </style>
</head>
<body>
<div class="container">

    <div id="groupInfo" th:if="${group}" th:data-group-id="${group.id}" th:data-original-name="${group.name}"></div>

    <div th:if="${errorMsg}" class="error-message" th:text="${errorMsg}"></div>
    <div th:if="${successMsg}" class="success-message" th:text="${successMsg}"></div>

    <div class="form_box" th:if="${group}">
        <form th:action="@{/group/fix/{groupId}(groupId=${group.id})}" method="post" id="groupFixForm">

            <div class="form-group">
                <label for="groupName">그룹 이름</label>
                <input type="text" class="input_long blue_line" id="groupName" name="groupName" th:value="${groupName ?: group.name}" placeholder="수정할 그룹 이름을 입력하세요" required>
                <span id="groupNameCheckResult" class="name-check-result"></span>
            </div>

            <div class="box white form-group">
                <div class="title dark_blue2">
                    <label>CREW</label><div class="underline dark_blue1"></div>
                </div>
                <div class="member-list" th:if="${group.users != null and not #lists.isEmpty(group.users)}">
                    <div class="member_one" th:each="gu : ${group.users}" th:if="${gu.user != null}">
                        <div class="member_img_box">
                            <div class="member_img">
                                <img th:src="${(gu.user.img != null and !gu.user.img.isEmpty()) ? (gu.user.img.startsWith('http') ? gu.user.img : '/image/getimg?fileName=' + #uris.escapePath(gu.user.img)) : '/img/bookduck_login.png'}"
                                     th:alt="${gu.user.nickName}" th:title="${gu.user.nickName}"
                                     onerror="this.onerror=null; this.src='/img/bookduck_login.png';">
                            </div>
                            <div class="btn_circle_mini yellow" th:if="${gu.role == T(com.my.bookduck.domain.group.GroupUser.Role).ROLE_LEADER}"><i class="fa-solid fa-crown"></i></div>
                        </div>
                        <div class="member_name"><span th:text="${gu.user.nickName}">닉네임</span></div>
                    </div>
                </div>
                <div th:if="${group.users == null or #lists.isEmpty(group.users)}" class="read-only-info error">
                    그룹 멤버 정보가 없습니다.
                </div>
            </div>


            <div class="book-section">
                <div class="form-group book-search-container">
                    <label for="bookSearchInput">도서 추가</label>
                    <input class="input_long yellow_line" type="text" id="bookSearchInput" placeholder="추가할 도서를 검색하세요">
                    <span id="bookAddCheckResult" class="book-check-result" style="display: none;"></span>
                    <ul id="bookSearchResults"></ul>
                </div>

                <div class="box light_yellow" id="selectedBookDisplay" style="display: none;">
                    <img id="selectedBookCover" src="/img/default_book_cover.png" alt="Selected book cover">
                    <span id="selectedBookTitle"></span>
                    <button type="button" id="cancelAddBook" title="추가 취소">×</button>
                </div>
                <input type="hidden" id="newBookId" name="newBookId">

                <!-- === 그룹 도서 목록 HTML 구조 변경 === -->
                <div class="group-book-list-container box white"> <!-- 외부 컨테이너 추가 -->
                    <div class="title dark_blue2">그룹 도서<div class="underline dark_blue1"></div></div>
                    <div class="group-book-list" id="currentGroupBooks"> <!-- 실제 목록 ul 역할 -->
                        <!-- 서버 렌더링 부분 -->
                        <th:block th:if="${group.books != null and not #lists.isEmpty(group.books)}">
                            <div th:each="gb : ${group.books}" class="group-book-item" th:if="${gb.book != null}"
                                 th:data-book-id="${gb.book.id}"
                                 th:data-book-title="${gb.book.title}">
                                <div class="box_img_btn"> <!-- 이미지와 버튼 컨테이너 -->
                                    <img class="select_book_img"
                                         th:src="${(gb.book.cover != null and !gb.book.cover.isEmpty()) ? (gb.book.cover.startsWith('http') ? gb.book.cover : '/image/getimg?fileName=' + #uris.escapePath(gb.book.cover)) : '/img/default_book_cover.png'}"
                                         th:alt="${gb.book.title}"
                                         onerror="this.onerror=null; this.src='/img/default_book_cover.png';">
                                    <!-- 공개/비공개 버튼 -->
                                    <button type="button"
                                            class="toggle-privacy-btn"
                                    th:classappend="${publicBookIds != null and gb.book.id != null and publicBookIds.contains(gb.book.id)} ? 'is-public' : 'is-private'"
                                    th:data-is-public="${publicBookIds != null and gb.book.id != null and publicBookIds.contains(gb.book.id)}">
                                    <i class="fa-solid fa-bullhorn btn_icon white2"></i> <!-- 아이콘 추가 -->
                                    </button>
                                    <!-- 삭제 버튼 -->
                                    <button type="button" class="delete-book-btn" title="그룹에서 삭제"> <!-- CSS에서 정의한 클래스 사용 -->
                                        <i class="fa-solid fa-xmark btn_icon white2"></i> <!-- 아이콘 추가 -->
                                    </button>
                                </div>
                                <div class="select_book_title" th:title="${gb.book.title}" th:text="${gb.book.title}">책 제목</div>
                            </div>
                        </th:block>
                        <!-- 도서 없을 때 메시지 -->
                        <p th:if="${group.books == null or #lists.isEmpty(group.books)}" class="no-books-message error under_margin">
                            등록된 그룹 도서가 없습니다.
                        </p>
                    </div>
                </div>
                <!-- ================================ -->
            </div>

            <input type="hidden" name="bookId" th:value="${group.books != null and not #lists.isEmpty(group.books) and group.books[0].book != null ? group.books[0].book.id : ''}">

            <button type="submit" class="btn_long submit-button">수정 완료</button>

        </form>
    </div>

    <div th:unless="${group}" class="error-message error_box">
        <div class="error under_margin">그룹 정보를 불러올 수 없습니다. 그룹 목록으로 돌아가거나 관리자에게 문의하세요.</div>
        <button class="btn_long yellow" onclick="location.href='/group/list'">그룹 목록으로 가기</button>
    </div>

</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    // --- CSRF 토큰 설정 ---
    const csrfToken = document.querySelector("meta[name='_csrf']")?.content;
    const csrfHeader = document.querySelector("meta[name='_csrf_header']")?.content;
    const headers = { 'Content-Type': 'application/json' };
    if (csrfToken && csrfHeader) {
        headers[csrfHeader] = csrfToken;
        console.log("CSRF Header:", csrfHeader, "Token:", csrfToken ? 'OK' : 'MISSING');
    } else {
        console.warn("CSRF meta tags not found. Non-GET requests might fail.");
    }

    document.addEventListener('DOMContentLoaded', function() {

        const groupInfoDiv = document.getElementById('groupInfo');
        const currentGroupId = groupInfoDiv ? groupInfoDiv.dataset.groupId : null;
        const originalGroupName = groupInfoDiv ? groupInfoDiv.dataset.originalName : null;
        const groupFixForm = document.getElementById('groupFixForm');

        if (!groupFixForm || !currentGroupId) {
            console.warn("Group form or group ID missing. Initialization skipped.");
            return;
        }

        const groupNameInput = document.getElementById('groupName');
        const nameCheckResultSpan = document.getElementById('groupNameCheckResult');
        const submitButton = groupFixForm.querySelector('button.submit-button');
        const searchInput = document.getElementById('bookSearchInput');
        const resultsContainer = document.getElementById('bookSearchResults');
        const newBookIdInput = document.getElementById('newBookId');
        const bookAddCheckResultSpan = document.getElementById('bookAddCheckResult');
        const selectedBookDisplay = document.getElementById('selectedBookDisplay');
        const selectedBookCover = document.getElementById('selectedBookCover');
        const selectedBookTitle = document.getElementById('selectedBookTitle');
        const cancelAddBookBtn = document.getElementById('cancelAddBook');
        const currentGroupBooksList = document.getElementById('currentGroupBooks'); // 실제 책 목록 ul/div

        let nameCheckDebounceTimer;
        let isNameAvailable = true;
        let bookSearchDebounceTimer;

        // --- 그룹 이름 중복 확인 (기존 유지) ---
        if (groupNameInput && nameCheckResultSpan && submitButton) {
            groupNameInput.addEventListener('input', () => {
                clearTimeout(nameCheckDebounceTimer);
                const newName = groupNameInput.value.trim();
                nameCheckResultSpan.textContent = ''; nameCheckResultSpan.className = 'name-check-result';
                isNameAvailable = true; submitButton.disabled = false;
                if (newName === '') { nameCheckResultSpan.textContent = '그룹 이름을 입력해주세요.'; nameCheckResultSpan.classList.add('name-unavailable'); isNameAvailable = false; submitButton.disabled = true; return; }
                if (originalGroupName && newName.toLowerCase() === originalGroupName.toLowerCase()) { isNameAvailable = true; submitButton.disabled = false; return; }
                nameCheckDebounceTimer = setTimeout(() => {
                    nameCheckResultSpan.textContent = '확인 중...'; groupNameInput.disabled = true; submitButton.disabled = true;
                    fetch(`/group/check-name?name=${encodeURIComponent(newName)}`)
                        .then(response => { if (!response.ok) throw new Error('Network error'); return response.json(); })
                        .then(data => { if (data.isAvailable) { nameCheckResultSpan.textContent = '사용 가능'; nameCheckResultSpan.classList.add('name-available'); isNameAvailable = true; } else { nameCheckResultSpan.textContent = '이미 사용 중'; nameCheckResultSpan.classList.add('name-unavailable'); isNameAvailable = false; } })
                        .catch(error => { console.error('Name check error:', error); nameCheckResultSpan.textContent = '확인 오류'; nameCheckResultSpan.classList.add('name-unavailable'); isNameAvailable = false; })
                        .finally(() => { groupNameInput.disabled = false; submitButton.disabled = !isNameAvailable; });
                }, 500);
            });
        }

        // --- 책 검색 (기존 유지) ---
        if (searchInput && resultsContainer && bookAddCheckResultSpan && newBookIdInput && selectedBookDisplay && selectedBookCover && selectedBookTitle) {
            searchInput.addEventListener('input', () => {
                clearTimeout(bookSearchDebounceTimer);
                const query = searchInput.value.trim();
                bookAddCheckResultSpan.style.display = 'none'; resultsContainer.innerHTML = ''; resultsContainer.style.display = 'none';
                if (query.length < 1) return;
                bookSearchDebounceTimer = setTimeout(() => {
                    fetch(`/book/search?title=${encodeURIComponent(query)}&limit=5`)
                        .then(response => { if (response.status === 401) throw new Error('로그인 필요'); if (!response.ok) throw new Error('검색 실패'); return response.json(); })
                        .then(books => {
                            if (books && books.length > 0) {
                                books.forEach(book => {
                                    const li = document.createElement('li'); const img = document.createElement('img');
                                    let coverSrc = book.cover ? book.cover : '/img/default_book_cover.png';
                                    img.src = coverSrc.startsWith('http') ? coverSrc : (coverSrc === '/img/default_book_cover.png' ? coverSrc : `/image/getimg?fileName=${encodeURIComponent(coverSrc)}`);
                                    img.alt = (book.title || '') + ' 표지'; img.onerror = function() { this.onerror=null; this.src='/img/default_book_cover.png'; };
                                    li.appendChild(img);
                                    const span = document.createElement('span'); span.textContent = book.title || '제목 없음'; li.appendChild(span);
                                    li.dataset.bookId = book.id; li.dataset.bookTitle = book.title || ''; li.dataset.bookCover = book.cover || '';
                                    li.addEventListener('click', () => {
                                        const clickedBookId = li.dataset.bookId; const clickedBookTitle = li.dataset.bookTitle; const clickedBookCover = li.dataset.bookCover; let isAlreadyInGroup = false;
                                        if (currentGroupBooksList) { currentGroupBooksList.querySelectorAll('.group-book-item').forEach(item => { if (item.dataset.bookId === clickedBookId) isAlreadyInGroup = true; }); }
                                        if (isAlreadyInGroup) { bookAddCheckResultSpan.textContent = `'${clickedBookTitle}' 책은 이미 그룹에 있습니다.`; bookAddCheckResultSpan.style.display = 'block'; newBookIdInput.value = ''; selectedBookDisplay.style.display = 'none'; }
                                        else { bookAddCheckResultSpan.style.display = 'none'; newBookIdInput.value = clickedBookId; selectedBookTitle.textContent = clickedBookTitle;
                                            let selectedCoverSrc = clickedBookCover ? clickedBookCover : '/img/default_book_cover.png';
                                            selectedBookCover.src = selectedCoverSrc.startsWith('http') ? selectedCoverSrc : (selectedCoverSrc === '/img/default_book_cover.png' ? selectedCoverSrc : `/image/getimg?fileName=${encodeURIComponent(selectedCoverSrc)}`);
                                            selectedBookCover.onerror = function() { this.onerror=null; this.src='/img/default_book_cover.png'; };
                                            selectedBookDisplay.style.display = 'flex'; }
                                        searchInput.value = ''; resultsContainer.innerHTML = ''; resultsContainer.style.display = 'none';
                                    });
                                    resultsContainer.appendChild(li);
                                });
                                resultsContainer.style.display = 'block';
                            } else { const li = document.createElement('li'); li.textContent = '검색 결과 없음'; resultsContainer.appendChild(li); resultsContainer.style.display = 'block'; }
                        })
                        .catch(error => { console.error('Book search error:', error); resultsContainer.innerHTML = `<li>검색 오류: ${error.message}</li>`; resultsContainer.style.display = 'block'; });
                }, 300);
            });
        }

        // --- 추가 취소 버튼 (기존 유지) ---
        if (cancelAddBookBtn && newBookIdInput && selectedBookDisplay && bookAddCheckResultSpan && searchInput) {
            cancelAddBookBtn.addEventListener('click', () => { newBookIdInput.value = ''; selectedBookDisplay.style.display = 'none'; bookAddCheckResultSpan.style.display = 'none'; searchInput.value = ''; });
        }

        // --- 검색 결과 외부 클릭 시 숨김 (기존 유지) ---
        document.addEventListener('click', (event) => { if (resultsContainer && !resultsContainer.contains(event.target) && event.target !== searchInput) { resultsContainer.style.display = 'none'; } });

        // --- 폼 제출 유효성 검사 (기존 유지) ---
        if (groupFixForm && groupNameInput && submitButton && newBookIdInput && bookAddCheckResultSpan) {
            groupFixForm.addEventListener('submit', function(event) {
                if (groupNameInput.value.trim() === '') { alert('그룹 이름을 입력해주세요.'); event.preventDefault(); groupNameInput.focus(); return; }
                if (!isNameAvailable) { alert('사용할 수 없는 그룹 이름입니다.'); event.preventDefault(); groupNameInput.focus(); return; }
                // 수정: 중복 메시지 확인 로직 강화
                if (newBookIdInput.value !== '' && bookAddCheckResultSpan.style.display !== 'none' && bookAddCheckResultSpan.textContent.includes('이미 그룹에')) {
                    alert('이미 그룹에 있는 책은 추가할 수 없습니다.');
                    event.preventDefault();
                    return;
                }
                submitButton.disabled = true; submitButton.textContent = '처리 중...';
            });
        }

        // --- 책 삭제 및 공개/비공개 토글 (이벤트 위임 및 로직 유지) ---
        if (currentGroupBooksList) {
            currentGroupBooksList.addEventListener('click', function(event) {
                const toggleButton = event.target.closest('.toggle-privacy-btn');
                const deleteButton = event.target.closest('.delete-book-btn');

                if (!toggleButton && !deleteButton) return;

                const listItem = event.target.closest('.group-book-item');
                const bookId = listItem ? listItem.dataset.bookId : null;
                const bookTitle = listItem ? (listItem.dataset.bookTitle || '해당 책') : '해당 책';

                if (!bookId || !currentGroupId) { alert('책 또는 그룹 정보를 찾을 수 없습니다.'); return; }

                // --- 공개/비공개 토글 ---
                if (toggleButton) {
                    console.log(`Toggle privacy: BookID=${bookId}, GroupID=${currentGroupId}`);
                    toggleButton.disabled = true;
                    const icon = toggleButton.querySelector('i');
                    const originalIconHTML = icon ? icon.outerHTML : ''; // 아이콘 HTML 저장
                    toggleButton.innerHTML = '...';

                    fetch(`/group/api/group/${currentGroupId}/book/${bookId}/toggle-privacy`, { method: 'POST', headers: headers })
                        .then(async response => { /* (응답 처리 로직 기존 유지) */ const body = await response.text(); let json={}; try {json=body?JSON.parse(body):{};}catch(e){throw new Error(body||`HTTP ${response.status}`);} if(!response.ok){throw new Error(json.error||`HTTP ${response.status}`);} return json; })
                        .then(data => { const newIsPublic = data.isPublic; console.log(`Toggle success: ${newIsPublic ? 'Public' : 'Private'}`); toggleButton.dataset.isPublic = newIsPublic; toggleButton.classList.toggle('is-public', newIsPublic); toggleButton.classList.toggle('is-private', !newIsPublic); })
                        .catch(error => { console.error('Error toggling privacy:', error); alert(`상태 변경 오류: ${error.message}`); })
                        .finally(() => { toggleButton.disabled = false; toggleButton.innerHTML = originalIconHTML; }); // 아이콘 HTML 복구
                }

                // --- 책 삭제 ---
                else if (deleteButton) {
                    if (confirm(`'${bookTitle}' 책을 그룹에서 삭제하시겠습니까?`)) {
                        deleteButton.disabled = true;
                        const icon = deleteButton.querySelector('i');
                        const originalIconHTML = icon ? icon.outerHTML : '';
                        deleteButton.innerHTML = '...';

                        fetch(`/group/fix/${currentGroupId}/book/${bookId}`, { method: 'DELETE', headers: headers })
                            .then(async response => { const body = await response.text(); let msg=body; if(!response.ok){ try{msg=JSON.parse(body).error||body;}catch(e){} throw new Error(msg||`삭제 실패 (${response.status})`); } listItem.remove(); alert('삭제되었습니다.'); console.log(`Deleted book ID: ${bookId}`); if(currentGroupBooksList.querySelectorAll('.group-book-item').length===0){ const p=document.createElement('p'); p.className='no-books-message error under_margin'; p.textContent='등록된 그룹 도서가 없습니다.'; const titleDiv=currentGroupBooksList.closest('.group-book-list-container').querySelector('.title'); if(titleDiv) titleDiv.insertAdjacentElement('afterend', p); else currentGroupBooksList.closest('.group-book-list-container').appendChild(p);} })
                            .catch(error => { console.error('Error deleting book:', error); alert(`삭제 오류: ${error.message}`); deleteButton.disabled = false; deleteButton.innerHTML = originalIconHTML; });
                    }
                }
            });
        }

    }); // End of DOMContentLoaded
    /*]]>*/
</script>

</body>
</html>