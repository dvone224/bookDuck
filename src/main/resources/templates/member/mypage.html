<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/member/mypage.css">
    <script src="https://kit.fontawesome.com/116a85af51.js" crossorigin="anonymous"></script>
    <style>
        /* --- 기존 스타일 유지 --- */
        .crew_list, .book_list { display: flex; flex-wrap: wrap; gap: 15px; padding-bottom: 10px; }
        .crew_one, .book_one { width: calc((100% - 30px) / 3); text-align: center; display: flex; flex-direction: column; align-items: center; margin-bottom: 15px; }
        .crew_book_img, .book_img { width: 100%; aspect-ratio: 100 / 140; margin-bottom: 5px; border: 1px solid #eee; display: flex; justify-content: center; align-items: center; overflow: hidden; background-color: #f8f8f8; }
        .crew_book_img img, .book_img img { width: 100%; height: 100%; object-fit: cover; }
        .crew_tag { font-size: 0.8em; background-color: #5dade2; color: white; padding: 2px 6px; border-radius: 4px; margin-bottom: 5px; }
        .crew_name { font-size: 0.9em; color: #333; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .no-content { width: 100%; text-align: center; color: #777; padding: 20px 0; }
        .box_side { width: 100%; text-align: right; padding-top: 5px; }
        .book_one_title { font-size: 0.9em; margin-top: 5px; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- 모달 스타일 (home.html 스타일과 통합) --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }
        .modal-content {
            background-color: var(--main-color-light);
            margin: 10% auto;
            padding: 20px;
            border: 2px solid var(--main-color-middle);
            width: 80%;
            max-width: 768px;
            border-radius: var(--border-middle);
            position: relative;
            font-family: 'GowunBatang-Regular';
            animation-name: animatetop;
            animation-duration: 0.4s;
        }
        @keyframes animatetop {
            from { top: -300px; opacity: 0 }
            to { top: 0; opacity: 1 }
        }
        .close-button {
            width: 35px;
            height: 35px;
            border-radius: var(--border-circle);
            background: var(--assist-color-middle);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: var(--font-size-2);
        }
        .close-button:hover {
            background: var(--assist-color-dark);
        }
        .modal-title {
            font-size: var(--font-size-1);
            font-weight: bold;
            color: var(--main-color-dark);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--main-color-middle);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        .modal-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border-radius: var(--border-middle);
            border: 1px solid var(--main-color-middle);
        }
        .modal-item:last-child {
            margin-bottom: 0;
        }
        .modal-item img {
            width: 60px;
            height: 85px;
            object-fit: cover;
            margin-right: 15px;
            border-radius: var(--border-middle);
            background-color: var(--main-color-light);
        }
        .modal-item-info {
            flex-grow: 1;
        }
        .modal-item-title {
            font-size: var(--font-size-2);
            font-weight: bold;
            color: var(--main-color-dark);
            margin-bottom: 5px;
        }
        .modal-item-sub {
            font-size: var(--font-size-3);
            color: var(--cancle-color-dark);
        }
        .loader {
            border: 5px solid var(--main-color-light);
            border-top: 5px solid var(--main-color-middle);
            border-radius: var(--border-circle);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* --- 그룹 모달 책 목록 스타일 (list.html 기반, mypage.html 스타일 적용) --- */
        .modal-book-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            padding: 0;
        }
        .modal-book-item {
            background-color: white;
            border: 1px solid var(--main-color-middle);
            border-radius: var(--border-middle);
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: calc(25% - 12px); /* 4개씩 배치 */
            box-sizing: border-box;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
            min-height: 150px;
        }
        .modal-book-item:hover {
            transform: translateY(-2px);
        }
        .modal-book-item img {
            width: 60px;
            height: 85px;
            object-fit: cover;
            border-radius: var(--border-middle);
            margin-bottom: 8px;
            background-color: var(--main-color-light);
        }
        .modal-book-item span {
            font-size: var(--font-size-3);
            color: var(--main-color-dark);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 2.4em;
            line-height: 1.2em;
        }
        .modal-loading, .modal-no-books {
            text-align: center;
            color: var(--cancle-color-dark);
            margin-top: 20px;
            font-size: var(--font-size-2);
            padding: 20px 0;
        }
    </style>
    <title> BookDuck²::My Page </title>
</head>
<body>
<div th:replace="~{fragments/therdHeader :: bodyHeader}" ></div>

<div class="container">
    <!-- 프로필 정보 -->
    <div class="profile_img_box">
        <div class="profile_img">
            <!-- 메인 프로필 이미지 -->
            <img th:src="${(loginuser != null and loginuser.img != null and !loginuser.img.isEmpty()) ?
                           (loginuser.img.startsWith('http') ? loginuser.img : '/image/getimg?fileName=' + #uris.escapePath(loginuser.img)) :
                           '/img/bookduck_login.png'}"
                 alt="Profile Image" id="userProfileImage"
                 onerror="this.onerror=null; this.src='/img/bookduck_login.png';">

            <!-- JS로 제어될 수 있는 원본 이미지 (필요시 사용, 초기에는 숨김 또는 JS로 관리) -->
            <img id="useroriginimg"
                 th:src="${(loginuser != null and loginuser.img != null and !loginuser.img.isEmpty()) ?
                           (loginuser.img.startsWith('http') ? loginuser.img : '/image/getimg?fileName=' + #uris.escapePath(loginuser.img)) :
                           '/img/bookduck_login.png'}"
                 alt="Original Profile Image"
                 style="display:none;"
            onerror="this.onerror=null; this.src='/img/bookduck_login.png';">

            <!-- 정적 플레이스홀더 (위의 userProfileImage가 기본 이미지를 처리하므로 중복될 수 있음, 필요 없다면 제거 가능) -->
            <!-- <img src="/img/bookduck_login.png" alt="Profile Image"> -->

            <input type="hidden" id="originImg" th:value="${loginuser?.img}"> <!-- 컨트롤러에서 전달된 loginuser 객체의 img 사용 -->
        </div>
        <div class="btn_circle yellow fix" onclick="location.href='/userupdate'">
            <i class="fa-solid fa-pen icon_white"></i>
        </div>
    </div>
    <div class="nickname dark_blue2" th:text="${loginuser?.nickName != null ? loginuser.nickName + '님' : '로그인 정보 없음'}">닉네임님</div>

    <!-- MY CREW 섹션 -->
    <div class="my_crew box light_blue">
        <div class="title dark_blue2">MY CREW<div class="line_long dark_blue1"></div></div>
        <div class="box_temp">
            <!-- 그룹 목록 미리보기 -->
            <div class="crew_list" th:if="${not #lists.isEmpty(myGroupsPreview)}">
                <div class="crew_one" th:each="groupView : ${myGroupsPreview}" th:data-group-id="${groupView.group.id}">
                    <div class="crew_book_img">
                        <img th:src="${(groupView.group != null and not #lists.isEmpty(groupView.group.books) and groupView.group.books[0].book != null and groupView.group.books[0].book.cover != null) ?
                                       (groupView.group.books[0].book.cover.startsWith('http') ? groupView.group.books[0].book.cover : '/image/getimg?fileName=' + #uris.escapePath(groupView.group.books[0].book.cover) ) :
                                       '/img/default_crew_icon.png'}"
                             alt="Crew Image"
                             onerror="this.onerror=null; this.src='/img/default_crew_icon.png';">
                    </div>
                    <div class="crew_tag">CREW</div>
                    <div class="crew_name" th:text="${groupView.group?.name ?: '이름 없음'}" th:title="${groupView.group?.name}">그룹 이름</div>
                </div>
            </div>
            <div class="no-content" th:if="${#lists.isEmpty(myGroupsPreview)}">
                <p>가입한 그룹이 없습니다.</p>
            </div>
            <div class="box_side" th:if="${hasMoreGroups}">
                <button class="more btn_mini blue" onclick="location.href='/group/list'">더보기</button>
            </div>
        </div>
    </div>

    <!-- MY BOOK 섹션 -->
    <div class="my_book box light_yellow">
        <div class="title dark_yellow2">MY BOOK<div class="line_long dark_yellow1"></div></div>
        <div class="box_temp">
            <!-- 책 목록 미리보기 -->
            <div class="book_list" th:if="${not #lists.isEmpty(myBooksPreview)}">
                <div class="book_one" th:each="book : ${myBooksPreview}">
                    <div class="book_img">
                        <img th:src="${(book.cover != null and !book.cover.isEmpty()) ?
                                       (book.cover.startsWith('http') ? book.cover : '/image/getimg?fileName=' + #uris.escapePath(book.cover)) :
                                       '/img/default_book_cover.png'}"
                             th:alt="${book.title}"
                             onerror="this.onerror=null; this.src='/img/default_book_cover.png';">
                    </div>
                    <div class="book_one_title" th:text="${book.title}" th:title="${book.title}"></div> <!-- 책 제목 표시 추가 -->
                </div>
            </div>
            <div class="no-content" th:if="${#lists.isEmpty(myBooksPreview)}">
                <p>내 서재에 등록된 책이 없습니다.</p>
            </div>
            <div class="box_side" th:if="${hasMoreBooks}">
                <button class="more btn_mini yellow" onclick="openModal('book')">더보기</button>
            </div>
        </div>
    </div>

    <!-- 로그아웃 버튼 -->
    <button class="logout btn_long yellow" onclick="location.href='/logout'">LOGOUT</button>
</div>

<!-- ======================= 모달 창 구조 ======================= -->

<!-- 책 목록 모달 -->
<div id="bookModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('bookModal')">×</span>
        <h3 class="modal-title">내 서재</h3>
        <div id="bookListContainer" class="modal-list">
            <div class="loader" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- 그룹 책 목록 모달 -->
<div id="groupModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('groupModal')">×</span>
        <h3 class="modal-title" id="groupModalTitle">그룹 도서 목록</h3>
        <div id="groupListContainer" class="modal-list">
            <div class="loader" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- ======================= JavaScript ======================= -->
<script>
    function openModal(type, groupId, groupName) {
        let modalId, listContainerId, apiUrl, title;

        if (type === 'book') {
            modalId = 'bookModal';
            listContainerId = 'bookListContainer';
            apiUrl = '/api/my-books'; // 이 API는 책 객체 리스트를 반환 (id, title, cover, writer 포함)
            title = '내 서재';
        } else if (type === 'group') {
            modalId = 'groupModal';
            listContainerId = 'groupListContainer';
            apiUrl = `/group/api/group/${groupId}/books`; // 이 API는 책 객체 리스트를 반환 (cover, title 등 포함)
            title = `${groupName || '그룹'} 도서 목록`;
        } else {
            console.error('Unsupported modal type:', type);
            return;
        }

        const modal = document.getElementById(modalId);
        const listContainer = document.getElementById(listContainerId);
        const modalTitle = modal.querySelector('.modal-title');
        let loader = listContainer.querySelector('.loader');
        if (!loader) {
            loader = document.createElement('div');
            loader.className = 'loader';
            // loader는 listContainer의 첫 번째 자식으로 추가하거나, 특정 위치에 추가
            if (listContainer.firstChild) {
                listContainer.insertBefore(loader, listContainer.firstChild);
            } else {
                listContainer.appendChild(loader);
            }
        }

        // 기존 목록(ul) 제거 (로더 제외)
        const existingUl = listContainer.querySelector('ul.modal-book-list');
        if (existingUl) {
            listContainer.removeChild(existingUl);
        }
        const existingNoBooksMessage = listContainer.querySelector('.modal-no-books');
        if (existingNoBooksMessage) {
            listContainer.removeChild(existingNoBooksMessage);
        }

        loader.style.display = 'block';
        modalTitle.textContent = title;
        modal.style.display = 'block';

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || '데이터를 불러오는데 실패했습니다.') });
                }
                return response.json();
            })
            .then(data => {
                loader.style.display = 'none';
                if (!data || data.length === 0) {
                    const noBooksDiv = document.createElement('div');
                    noBooksDiv.className = 'modal-no-books';
                    noBooksDiv.textContent = (type === 'book' ? '내 서재에 등록된 책이 없습니다.' : '등록된 그룹 도서가 없습니다.');
                    listContainer.appendChild(noBooksDiv);
                    return;
                }
                renderModalBookList(data, listContainer, type); // type 전달
            })
            .catch(error => {
                console.error(`Error fetching ${type} data:`, error);
                loader.style.display = 'none';
                const errorDiv = document.createElement('div');
                errorDiv.className = 'modal-no-books'; // 동일한 스타일 사용
                errorDiv.textContent = error.message || '오류가 발생했습니다.';
                listContainer.appendChild(errorDiv);
            });
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            const listContainer = modal.querySelector('.modal-list');
            if (listContainer) {
                // 모달 닫을 때 ul.modal-book-list 와 .modal-no-books 메시지 제거
                const ul = listContainer.querySelector('ul.modal-book-list');
                if (ul) listContainer.removeChild(ul);
                const noBooksMessage = listContainer.querySelector('.modal-no-books');
                if (noBooksMessage) listContainer.removeChild(noBooksMessage);

                const loader = listContainer.querySelector('.loader');
                if (loader) loader.style.display = 'none';
            }
        }
    }

    window.onclick = function(event) {
        const bookModal = document.getElementById('bookModal');
        const groupModal = document.getElementById('groupModal');
        if (event.target === bookModal) {
            closeModal('bookModal');
        } else if (event.target === groupModal) {
            closeModal('groupModal');
        }
    }

    function renderModalBookList(books, listContainer, type) { // type 파라미터 추가
        if (!listContainer) return;

        const ul = document.createElement('ul');
        ul.className = 'modal-book-list'; // CSS 클래스명 일치 확인

        books.forEach(book => {
            const li = document.createElement('li');
            li.className = 'modal-book-item';

            const img = document.createElement('img');
            let coverUrl = book.cover || '/img/default_book_cover.png';
            if (coverUrl && !coverUrl.startsWith('http') && !coverUrl.startsWith('/image/getimg')) {
                // 로컬 파일명으로 간주될 수 있는 경우 (S3 URL이 아니면서, 이미 /image/getimg 형식이 아닌 경우)
                // 이 부분은 API 응답의 cover 필드 형식에 따라 조정 필요
                // 현재 API(/api/my-books, /group/api/group/{groupId}/books)는 이미 완전한 URL 또는 기본 이미지 경로를 반환한다고 가정
            }
            // API 응답의 cover가 이미 S3 URL이거나 '/image/getimg?fileName=...' 형태, 또는 기본 이미지 경로라고 가정
            img.src = coverUrl.startsWith('http') ? coverUrl : (coverUrl.includes('/image/getimg') ? coverUrl : (coverUrl === '/img/default_book_cover.png' ? coverUrl : '/image/getimg?fileName=' + encodeURIComponent(coverUrl)));


            img.alt = book.title || '책 표지';
            img.onerror = function() { this.onerror=null; this.src='/img/default_book_cover.png'; };


            const span = document.createElement('span');
            span.textContent = book.title || '제목 없음';
            span.title = book.title || '';

            li.appendChild(img);
            li.appendChild(span);
            ul.appendChild(li);
        });
        listContainer.appendChild(ul);
    }

    const crewList = document.querySelector('.crew_list');
    if (crewList) {
        crewList.addEventListener('click', function(event) {
            const crewItem = event.target.closest('.crew_one');
            if (!crewItem) return;
            const groupId = crewItem.dataset.groupId;
            const groupName = crewItem.querySelector('.crew_name')?.textContent || '그룹';
            if (groupId) {
                openModal('group', groupId, groupName);
            }
        });
    }
</script>

<script src="https://code.jquery.com/jquery-3.6.3.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
        const originImgValue = $('#originImg').val();

        if (originImgValue && originImgValue.length !== 0) {
            let imgSrc = "";
            if (originImgValue.startsWith('http')) {
                imgSrc = originImgValue; // Full URL
            } else {
                imgSrc = "/image/getimg?fileName=" + encodeURIComponent(originImgValue); // Local filename
            }

            $('#useroriginimg')
                .attr("src", imgSrc)
                .on("error", function () {
                    console.log("User origin image failed to load: " + imgSrc);
                    $(this).attr("src", "/img/bookduck_login.png");
                });

            // 만약 userProfileImage도 JS로 설정하고 싶다면 (Thymeleaf SSR 대신)
            // $('#userProfileImage').attr("src", imgSrc).on("error", function() { $(this).attr("src", "/img/bookduck_login.png"); });

        } else {
            $('#useroriginimg').attr("src", "/img/bookduck_login.png");
            // $('#userProfileImage').attr("src", "/img/bookduck_login.png");
        }
    });
    /*]]>*/
</script>
<!-- Cloudflare 스크립트는 문제와 직접적인 관련이 없으므로 제거하거나 유지 (원본대로) -->
</body>
</html>