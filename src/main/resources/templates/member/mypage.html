<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/member/mypage.css">
    <script src="https://kit.fontawesome.com/116a85af51.js" crossorigin="anonymous"></script>
    <style>

/*아이콘 임포트*/
/* Fontawesome 4.7 */
@import url('https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css');

/*로고용 폰트: cafe24슈퍼매직*/
@font-face {
    font-family: 'Cafe24Supermagic-Bold-v1.0';
    src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2307-2@1.0/Cafe24Supermagic-Bold-v1.0.woff2') format('woff2');
    font-weight: 700;
    font-style: normal;
}

/*홈페이지 메인 폰트: 고운바탕*/
@font-face {
    font-family: 'GowunBatang-Regular';
    src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2108@1.1/GowunBatang-Regular.woff') format('woff');
    font-weight: normal;
    font-style: normal;
}

/*고운돋움*/
@font-face {
    font-family: 'GowunDodum-Regular';
    src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2108@1.1/GowunDodum-Regular.woff') format('woff');
    font-weight: normal;
    font-style: normal;
}

/*조선굴림*/
@font-face {
    font-family: 'ChosunGu';
    src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_20-04@1.0/ChosunGu.woff') format('woff');
    font-weight: normal;
    font-style: normal;
}

/*온글잎콘콘*/
@font-face {
    font-family: 'Ownglyph_corncorn-Rg';
    src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/2412-1@1.0/Ownglyph_corncorn-Rg.woff2') format('woff2');
    font-weight: normal;
    font-style: normal;
}

/*나눔손글씨펜*/
@import url('//fonts.googleapis.com/earlyaccess/nanumpenscript.css');
/*font-family: 'NanumPen';*/

/*학교안심꼬꼬마*/
@font-face {
    font-family: 'TTHakgyoansimKkokkomaR';
    src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2402_keris@1.0/TTHakgyoansimKkokkomaR.woff2') format('woff2');
    font-weight: normal;
    font-style: normal;
}

/*심경하*/
@font-face {
    font-family: 'SimKyungha';
    src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2202-2@1.0/SimKyungha.woff') format('woff');
    font-weight: normal;
    font-style: normal;
}

/*다이어리*/
@font-face {
    font-family: 'EarlyFontDiary';
    src: url('https://gcore.jsdelivr.net/gh/projectnoonnu/noonfonts_220508@1.0/EarlyFontDiary.woff2') format('woff2');
    font-weight: normal;
    font-style: normal;
}

/* 컬러 파레트 */
:root{
    --main-color-dark: #00479B;
    --main-color-middle: #83C7FF;
    --main-color-light: #E3F4FF;
    --assist-color-dark: #CE7000;
    --assist-color-middle: #FFB90B;
    --assist-color-light: #FFF7E6;
    --cancle-color-dark: #9B9B9B;
    --cancle-color-middle: #D3D3D3;
    --cancle-color-light: #EAEAEA;
    --crown-color: #ffa500;

    /*사용법: var(--main-color-middle)*/
    --border-big: 20px;/*큰거...뭐가잇지...*/
    --border-middle: 10px;/*img*/
    --border-circle: 50%;/*동그리버튼*/

    /*폰트 사이즈 정의*/
    --font-size-0: 28px;
    --font-size-1: 23px;
    --font-size-2: 18px;
    --font-size-3: 13px;
    --font-size-4: 8px;

    /*쪽지 색상 지정*/
    --memo1-color-dark: #00479B;
    --memo1-color-middle: #83C7FF;
    --memo1-color-light: #E3F4FF;
    --memo1-color-back: #B0CAD6;

    --memo2-color-dark: #CE7000;
    --memo2-color-middle: #FFB90B;
    --memo2-color-light: #FFF7E6;
    --memo2-color-back: #EAD4AD;

    --memo3-coler-dark: #841A1A;
    --memo3-coler-middle: #FF9494;
    --memo3-coler-light: #FFE9E9;
    --memo3-coler-back: #D6B0B0;

    --memo4-coler-dark: #325900;
    --memo4-coler-middle: #97CE41;
    --memo4-coler-light: #F6FFD9;
    --memo4-coler-back: #CCD3AE;

    --memo5-coler-dark: #A04800;
    --memo5-coler-middle: #FF8B00;
    --memo5-coler-light: #FFE3CA;
    --memo5-coler-back: #C9A88D;

    --memo6-coler-dark: #6A297A;
    --memo6-coler-middle: #AF80CE;
    --memo6-coler-light: #F5EEFF;
    --memo6-coler-back: #CDC3DD;

    --memo7-coler-dark: #1F1F77;
    --memo7-coler-middle: #7A8CE5;
    --memo7-coler-light: #E9ECFF;
    --memo7-coler-back: #B2B8D3;

    --memo8-coler-dark: #006466;
    --memo8-coler-middle: #66C6DD;
    --memo8-coler-light: #EBFFFF;
    --memo8-coler-back: #B8D3D2;
}

/* Global 스타일 초기화 */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: "Gowun Batang";
    font-size: var(--font-size-2);
}

/* 기본 설정 */
body {
    margin: 0;
    padding: 0;
    width: 100%; /* 가로를 화면에 맞게 설정 */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}


/* 컨테이너 스타일 */
.container {
    /*border: 1px solid slateblue;*/
    /*width: 100%;*/
    width: 768px;
    /*            max-width: 768px;*/
    /*max-width: 100%; !* 컨테이너 너비를 화면 너비에 맞춤 *!*/
    padding: 15px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
header{
    width: 768px;
    /*            max-width: 768px;*/
}

/*버튼 기본 규격*/
.btn_circle{
    /*            border: 1px solid red;*/
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    margin: 10px;
    /*            font-size: 20px;*/
}

.btn_circle .btn_icon{
    width: 25px;
    height: 25px;
    cursor: pointer;
}

.btn_circle .btn_icon_color{
    width: 35px;
    height: 35px;
    cursor: pointer;
}

.btn_circle_big{
    width: 55px;
    height: 55px;
    border-radius: 50%;
    color: white;
    cursor: pointer;
}

.btn_circle_big .btn_icon{
    width: 45px;
    height: 45px;
    cursor: pointer;
}

.btn_long{
    width: 100%;
    height: 45px;
    border-radius: 45px;
    color: white;
    cursor: pointer;
    border: none;
    font-weight: bold;
    max-width: 768px;
}

.btn_mini{
    width: auto;
    height: 25px;
    border-radius: 20px;
    color: white;
    cursor: pointer;
    border: none;
    font-size: var(--font-size-3);
    font-weight: bold;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 10px;
    margin-left: 5px;
}

.box{
    width: 100%;
    height: auto;
    border-radius: var(--border-big);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 10px;
    margin-bottom: 10px;
    max-width: 768px;
}

.title{
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    margin: 10px;
    font-weight: bold;
}

.bold{
    font-weight: bold;
}

.dot{
    width: 15px;
    height: 15px;
    border-radius: var(--border-circle);
    display: flex;
    margin-top: 5px;
    margin-right: 5px;
}

.underline{
    width: 130%;
    height: 1px;
}

.line{
    width: 100%;
    height: 1px;
}

.blue{
    background: var(--main-color-middle);
}
.blue2{
    color: var(--main-color-middle);
}
.yellow{
    background: var(--assist-color-middle);
}
.dark_blue1{
    background: var(--main-color-dark);
}
.dark_yellow1{
    background: var(--assist-color-dark);
}
.dark_blue2{
    color: var(--main-color-dark);
}
.dark_yellow2{
    color: var(--assist-color-dark);
}
.light_blue{
    background: var(--main-color-light);
}
.light_yellow{
    background: var(--assist-color-light);
}
.dark_gray1{
    background: var(--cancle-color-dark);
}
.dark_gray2{
    color: var(--cancle-color-dark);
}
.gray{
    background: var(--cancle-color-middle);
}
.gray2{
    color: var(--cancle-color-middle);
}
.light_gray{
    background: var(--cancle-color-light);
}
.white{
    background: white;
}
.white2{
    color: white;
}

.blue_line_thin{
    border: 1px solid var(--main-color-middle);
}
.yellow_line_thin{
    border: 1px solid var(--assist-color-middle);
}

.input_long{
    /*            margin-bottom: 10px;*/
    width: 100%;
    height: 45px;
    border-radius: 45px;
    box-sizing: border-box;
    text-align: center;
    max-width: 768px;
}

.blue_line{
    border: 2px solid var(--main-color-middle);
    color: var(--main-color-dark);
}

.blue_line:focus{
    border: 4px solid var(--main-color-middle);
    color: var(--main-color-dark);
    outline: none;
}

.yellow_line{
    border: 2px solid var(--assist-color-middle);
    color: var(--assist-color-dark);
}

.yellow_line:focus{
    border: 4px solid var(--assist-color-middle);
    color: var(--assist-color-dark);
    outline: none;
}


/*체크박스 CSS*/

input[type="checkbox"]{
    display: none;
}
input[type="checkbox"] + label{
    margin-right: 5px;
    display: inline-block;
    background: white;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    cursor: pointer;
    position: relative;
}
/*input[type="checkbox"] + label{
    border:3px solid var(--main-color-middle);
}*/
/*input[type="checkbox"] + label{
    border:3px solid var(--assist-color-middle);
}*/
input[type="checkbox"]:checked + label::after {
    content: '✔';
    font-size: 16px; /* 체크 아이콘 크기 조정 */
    width: 22px; /* 내부 원 크기 */
    height: 22px; /* 내부 원 크기 */
    border: none; /* 중복 테두리 제거 */
    color: white;
    text-align: center;
    line-height: 19px; /* 내부 원 높이와 동일하게 설정 */
    position: absolute;
    left: 50%; /* 중앙 정렬 */
    top: 50%; /* 중앙 정렬 */
    transform: translate(-50%, -50%); /* 정확한 중앙 배치 */
    border-radius: 50%; /* 내부 원형 유지 */
}
/*input[type="checkbox"]:checked + label::after{
    background: var(--main-color-middle);
}*/
/*input[type="checkbox"]:checked + label::after{
    background: var(--assist-color-middle);
}*/

/*대표 이미지들 설정*/
.processImg{
    width: 300px;
    height: 300px;
}
.processImg img{
    width: 100%;
    height: 100%;
}

.error{
    color: red;
    margin: 5px;
    text-align: center;
    font-size: var(--font-size-2);
}


@media screen and (max-width: 768px) { /* 768px 이하 화면 (태블릿 및 모바일) */
    .container {
        width: 100%;
    }
    header{
        width: 100%;
    }
}

@media screen and (max-width: 480px) { /* 480px 이하 화면 (스마트폰) */
    .container {
        padding: 5px; /* 모바일 화면에서는 여백 줄이기 */
        font-size: 14px; /* 작은 화면에 맞는 글꼴 크기 조정 */
    }
}

/* 여기까지 메인 CSS */

.test1{
    border: 1px solid red;
}
.test2{
    border: 1px solid blue;
}
/* test CSS */

.profile_img_box{
    width: 220px;
    height: 220px;
    position: relative;
}
.fix{
    position: absolute;
    bottom: -10px; /* 아래로 10px 이동 (원하는 값으로 조절) */
    right: -10px; /* 오른쪽으로 10px 이동 (원하는 값으로 조절) */
    transform: translate(0, 0); /* transform 제거 또는 초기화 */
}

.profile_img{
    width: 200px;
    height: 200px;
    background: var(--assist-color-light);
    border: 3px solid var(--assist-color-middle);
    border-radius: var(--border-big);
    position: absolute;
    top: 50%;
    left: 50%; /* right 대신 left 사용 */
    transform: translate(-50%, -50%); /* 중앙 정렬 */
}
.profile_img img{
    width: 100%;
    height: 100%;
    display: block; /* 이미지 아래 여백 제거 */
}

.nickname{
    font-size: var(--font-size-1);
    font-weight: bold;
    margin-top: 10px;
    margin-bottom: 20px;
}

.line_long{
    height: 1px;
    width: 400%;
}



.my_crew, .my_book{
    max-width: 600px;
    margin-bottom: 30px;
}

.crew_book_img, .book_img{
    border: 1px solid black;
    width: 120px;
    height: 160px;
    border-radius: var(--border-middle);
    margin: 10px;
    overflow: hidden;
}

.crew_book_img img,
.book_img img{
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.crew_list, .book_list{
    display: flex;
    justify-content: center;
    align-items: center;
}

.crew_one, .book_one{
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.crew_one{
    color: var(--main-color-dark);
}

.crew_tag{
    font-size: var(--font-size-3);
    font-weight: bold;
}

.box_side{
    width: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: flex-end;
    padding-right: 10px;
}
.box_side{
    margin-top: 10px;
    margin-bottom: 10px;
}

        /* --- 모달 스타일 (home.html 스타일과 통합) --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }
        .modal-content {
            background-color: var(--main-color-light);
            margin: 10% auto;
            padding: 20px;
            border: 2px solid var(--main-color-middle);
            width: 80%;
            max-width: 768px;
            border-radius: var(--border-middle);
            position: relative;
            font-family: 'GowunBatang-Regular';
            animation-name: animatetop;
            animation-duration: 0.4s;
        }
        @keyframes animatetop {
            from { top: -300px; opacity: 0 }
            to { top: 0; opacity: 1 }
        }
        .close-button {
            width: 35px;
            height: 35px;
            border-radius: var(--border-circle);
            background: var(--assist-color-middle);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: var(--font-size-2);
        }
        .close-button:hover {
            background: var(--assist-color-dark);
        }
        .modal-title {
            font-size: var(--font-size-1);
            font-weight: bold;
            color: var(--main-color-dark);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--main-color-middle);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        .modal-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border-radius: var(--border-middle);
            border: 1px solid var(--main-color-middle);
        }
        .modal-item:last-child {
            margin-bottom: 0;
        }
        .modal-item img {
            width: 60px;
            height: 85px;
            object-fit: cover;
            margin-right: 15px;
            border-radius: var(--border-middle);
            background-color: var(--main-color-light);
        }
        .modal-item-info {
            flex-grow: 1;
        }
        .modal-item-title {
            font-size: var(--font-size-2);
            font-weight: bold;
            color: var(--main-color-dark);
            margin-bottom: 5px;
        }
        .modal-item-sub {
            font-size: var(--font-size-3);
            color: var(--cancle-color-dark);
        }
        .loader {
            border: 5px solid var(--main-color-light);
            border-top: 5px solid var(--main-color-middle);
            border-radius: var(--border-circle);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- 그룹 모달 책 목록 스타일 (list.html 기반, mypage.html 스타일 적용) --- */
        .modal-book-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            padding: 0;
        }
        .modal-book-item {
            background-color: white;
            border: 1px solid var(--main-color-middle);
            border-radius: var(--border-middle);
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: calc(25% - 12px); /* 4개씩 배치 */
            box-sizing: border-box;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
            min-height: 150px;
        }
        .modal-book-item:hover {
            transform: translateY(-2px);
        }
        .modal-book-item img {
            width: 60px;
            height: 85px;
            object-fit: cover;
            border-radius: var(--border-middle);
            margin-bottom: 8px;
            background-color: var(--main-color-light);
        }
        .modal-book-item span {
            font-size: var(--font-size-3);
            color: var(--main-color-dark);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 2.4em;
            line-height: 1.2em;
        }
        .modal-loading, .modal-no-books {
            text-align: center;
            color: var(--cancle-color-dark);
            margin-top: 20px;
            font-size: var(--font-size-2);
            padding: 20px 0;
        }
    </style>
    <title> BookDuck²::My Page </title>
</head>
<body>
<div th:replace="~{fragments/therdHeader :: bodyHeader}" ></div>

<div class="container">
    <!-- 프로필 정보 -->
    <div class="profile_img_box">
        <div class="profile_img">
            <!-- 메인 프로필 이미지 -->
            <img th:src="${(loginuser != null and loginuser.img != null and !loginuser.img.isEmpty()) ?
                           (loginuser.img.startsWith('http') ? loginuser.img : '/image/getimg?fileName=' + #uris.escapePath(loginuser.img)) :
                           '/img/bookduck_login.png'}"
                 alt="Profile Image" id="userProfileImage"
                 onerror="this.onerror=null; this.src='/img/bookduck_login.png';">

            <!-- JS로 제어될 수 있는 원본 이미지 (필요시 사용, 초기에는 숨김 또는 JS로 관리) -->
            <img id="useroriginimg"
                 th:src="${(loginuser != null and loginuser.img != null and !loginuser.img.isEmpty()) ?
                           (loginuser.img.startsWith('http') ? loginuser.img : '/image/getimg?fileName=' + #uris.escapePath(loginuser.img)) :
                           '/img/bookduck_login.png'}"
                 alt="Original Profile Image"
                 style="display:none;"
                 onerror="this.onerror=null; this.src='/img/bookduck_login.png';">

            <input type="hidden" id="originImg" th:value="${loginuser?.img}">
        </div>
        <div class="btn_circle yellow fix" onclick="location.href='/userupdate'">
            <i class="fa-solid fa-pen icon_white"></i>
        </div>
    </div>
    <div class="nickname dark_blue2" th:text="${loginuser?.nickName != null ? loginuser.nickName + '님' : '로그인 정보 없음'}">닉네임님</div>

    <!-- MY CREW 섹션 -->
    <div class="my_crew box light_blue">
        <div class="title dark_blue2">MY CREW<div class="line_long dark_blue1"></div></div>
        <div class="box_temp">
            <!-- 그룹 목록 미리보기 -->
            <div class="crew_list" th:if="${not #lists.isEmpty(myGroupsPreview)}">
                <div class="crew_one" th:each="groupView : ${myGroupsPreview}" th:data-group-id="${groupView.group.id}">
                    <div class="crew_book_img">
                        <img th:src="${(groupView.group != null and not #lists.isEmpty(groupView.group.books) and groupView.group.books[0].book != null and groupView.group.books[0].book.cover != null) ?
                                       (groupView.group.books[0].book.cover.startsWith('http') ? groupView.group.books[0].book.cover : '/image/getimg?fileName=' + #uris.escapePath(groupView.group.books[0].book.cover) ) :
                                       '/img/default_crew_icon.png'}"
                             alt="Crew Image"
                             onerror="this.onerror=null; this.src='/img/default_crew_icon.png';">
                    </div>
                    <div class="crew_tag">CREW</div>
                    <div class="crew_name" th:text="${groupView.group?.name ?: '이름 없음'}" th:title="${groupView.group?.name}">그룹 이름</div>
                </div>
            </div>
            <div class="no-content" th:if="${#lists.isEmpty(myGroupsPreview)}">
                <p>가입한 그룹이 없습니다.</p>
            </div>
            <div class="box_side" th:if="${hasMoreGroups}">
                <button class="more btn_mini blue" onclick="location.href='/group/list'">더보기</button>
            </div>
        </div>
    </div>

    <!-- MY BOOK 섹션 -->
    <div class="my_book box light_yellow">
        <div class="title dark_yellow2">MY BOOK<div class="line_long dark_yellow1"></div></div>
        <div class="box_temp">
            <!-- 책 목록 미리보기 -->
            <div class="book_list" th:if="${not #lists.isEmpty(myBooksPreview)}">
                <div class="book_one" th:each="book : ${myBooksPreview}">
                    <div class="book_img">
                        <img th:src="${(book.cover != null and !book.cover.isEmpty()) ?
                                       (book.cover.startsWith('http') ? book.cover : '/image/getimg?fileName=' + #uris.escapePath(book.cover)) :
                                       '/img/default_book_cover.png'}"
                             th:alt="${book.title}"
                             onerror="this.onerror=null; this.src='/img/default_book_cover.png';">
                    </div>
                    <div class="book_one_title" th:text="${book.title}" th:title="${book.title}"></div>
                </div>
            </div>
            <div class="no-content" th:if="${#lists.isEmpty(myBooksPreview)}">
                <p>내 서재에 등록된 책이 없습니다.</p>
            </div>
            <div class="box_side" th:if="${hasMoreBooks}">
                <button class="more btn_mini yellow" onclick="openModal('book')">더보기</button>
            </div>
        </div>
    </div>

    <!-- 로그아웃 버튼 -->
    <button class="logout btn_long yellow" onclick="location.href='/logout'">LOGOUT</button>
</div>

<!-- ======================= 모달 창 구조 ======================= -->

<!-- 책 목록 모달 -->
<div id="bookModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('bookModal')">×</span>
        <h3 class="modal-title">내 서재</h3>
        <div id="bookListContainer" class="modal-list">
            <div class="loader" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- 그룹 책 목록 모달 -->
<div id="groupModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('groupModal')">×</span>
        <h3 class="modal-title" id="groupModalTitle">그룹 도서 목록</h3>
        <div id="groupListContainer" class="modal-list">
            <div class="loader" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- ======================= JavaScript ======================= -->
<script>
    // 코드 버전 확인
    console.log("mypage.html Version: 2025-05-10");

    function openModal(type, groupId, groupName) {
        let modalId, listContainerId, apiUrl, title;

        if (type === 'book') {
            modalId = 'bookModal';
            listContainerId = 'bookListContainer';
            apiUrl = '/api/my-books';
            title = '내 서재';
        } else if (type === 'group') {
            modalId = 'groupModal';
            listContainerId = 'groupListContainer';
            apiUrl = `/group/api/group/${groupId}/books`;
            title = `${groupName || '그룹'} 도서 목록`;
        } else {
            console.error('Unsupported modal type:', type);
            return;
        }

        const modal = document.getElementById(modalId);
        const listContainer = document.getElementById(listContainerId);
        const modalTitle = modal.querySelector('.modal-title');
        let loader = listContainer.querySelector('.loader');
        if (!loader) {
            loader = document.createElement('div');
            loader.className = 'loader';
            if (listContainer.firstChild) {
                listContainer.insertBefore(loader, listContainer.firstChild);
            } else {
                listContainer.appendChild(loader);
            }
        }

        // 기존 목록(ul) 제거 (로더 제외)
        const existingUl = listContainer.querySelector('ul.modal-book-list');
        if (existingUl) {
            listContainer.removeChild(existingUl);
        }
        const existingNoBooksMessage = listContainer.querySelector('.modal-no-books');
        if (existingNoBooksMessage) {
            listContainer.removeChild(existingNoBooksMessage);
        }

        loader.style.display = 'block';
        modalTitle.textContent = title;
        modal.style.display = 'block';

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || '데이터를 불러오는데 실패했습니다.') });
                }
                return response.json();
            })
            .then(data => {
                loader.style.display = 'none';
                if (!data || data.length === 0) {
                    const noBooksDiv = document.createElement('div');
                    noBooksDiv.className = 'modal-no-books';
                    noBooksDiv.textContent = (type === 'book' ? '내 서재에 등록된 책이 없습니다.' : '등록된 그룹 도서가 없습니다.');
                    listContainer.appendChild(noBooksDiv);
                    return;
                }
                renderModalBookList(data, listContainer, type);
            })
            .catch(error => {
                console.error(`Error fetching ${type} data:`, error);
                loader.style.display = 'none';
                const errorDiv = document.createElement('div');
                errorDiv.className = 'modal-no-books';
                errorDiv.textContent = error.message || '오류가 발생했습니다.';
                listContainer.appendChild(errorDiv);
            });
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            const listContainer = modal.querySelector('.modal-list');
            if (listContainer) {
                const ul = listContainer.querySelector('ul.modal-book-list');
                if (ul) listContainer.removeChild(ul);
                const noBooksMessage = listContainer.querySelector('.modal-no-books');
                if (noBooksMessage) listContainer.removeChild(noBooksMessage);
                const loader = listContainer.querySelector('.loader');
                if (loader) loader.style.display = 'none';
            }
        }
    }

    window.onclick = function(event) {
        const bookModal = document.getElementById('bookModal');
        const groupModal = document.getElementById('groupModal');
        if (event.target === bookModal) {
            closeModal('bookModal');
        } else if (event.target === groupModal) {
            closeModal('groupModal');
        }
    }

    function renderModalBookList(books, listContainer, type) {
        if (!listContainer) return;

        const ul = document.createElement('ul');
        ul.className = 'modal-book-list';

        books.forEach(book => {
            const li = document.createElement('li');
            li.className = 'modal-book-item';
            // 책 클릭 시 뷰어로 이동
            li.addEventListener('click', () => {
                console.log("Modal book item clicked:", book.title);
                window.location.href = '/book/viewer/1';
            });

            const img = document.createElement('img');
            let coverUrl = book.cover || '/img/default_book_cover.png';
            if (coverUrl && !coverUrl.startsWith('http') && !coverUrl.startsWith('/image/getimg')) {
                coverUrl = '/image/getimg?fileName=' + encodeURIComponent(coverUrl);
            }
            img.src = coverUrl;
            img.alt = book.title || '책 표지';
            img.onerror = function() { this.onerror=null; this.src='/img/default_book_cover.png'; };

            const span = document.createElement('span');
            span.textContent = book.title || '제목 없음';
            span.title = book.title || '';

            li.appendChild(img);
            li.appendChild(span);
            ul.appendChild(li);
        });
        listContainer.appendChild(ul);
    }

    // 책 미리보기 클릭 이벤트
    const bookList = document.querySelector('.book_list');
    if (bookList) {
        bookList.addEventListener('click', function(event) {
            const bookItem = event.target.closest('.book_one');
            if (!bookItem) return;
            const bookTitle = bookItem.querySelector('.book_one_title')?.textContent || '책';
            console.log("Book item clicked:", bookTitle);
            window.location.href = '/book/viewer/1';
        });
    }

    const crewList = document.querySelector('.crew_list');
    if (crewList) {
        crewList.addEventListener('click', function(event) {
            const crewItem = event.target.closest('.crew_one');
            if (!crewItem) return;
            const groupId = crewItem.dataset.groupId;
            const groupName = crewItem.querySelector('.crew_name')?.textContent || '그룹';
            if (groupId) {
                openModal('group', groupId, groupName);
            }
        });
    }
</script>

<script src="https://code.jquery.com/jquery-3.6.3.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
        const originImgValue = $('#originImg').val();

        if (originImgValue && originImgValue.length !== 0) {
            let imgSrc = "";
            if (originImgValue.startsWith('http')) {
                imgSrc = originImgValue;
            } else {
                imgSrc = "/image/getimg?fileName=" + encodeURIComponent(originImgValue);
            }

            $('#useroriginimg')
                .attr("src", imgSrc)
                .on("error", function () {
                    console.log("User origin image failed to load: " + imgSrc);
                    $(this).attr("src", "/img/bookduck_login.png");
                });
        } else {
            $('#useroriginimg').attr("src", "/img/bookduck_login.png");
        }
    });
    /*]]>*/
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93caf0028818453f',t:'MTc0NjcyODA3NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>