<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/member/mypage.css">
    <script src="https://kit.fontawesome.com/116a85af51.js" crossorigin="anonymous"></script>
    <style>
        /* --- 기존 스타일 유지 --- */
        .crew_list, .book_list { display: flex; flex-wrap: wrap; gap: 15px; padding-bottom: 10px; }
        .crew_one, .book_one { width: calc((100% - 30px) / 3); text-align: center; display: flex; flex-direction: column; align-items: center; margin-bottom: 15px; }
        .crew_book_img, .book_img { width: 100%; aspect-ratio: 100 / 140; margin-bottom: 5px; border: 1px solid #eee; display: flex; justify-content: center; align-items: center; overflow: hidden; background-color: #f8f8f8; }
        .crew_book_img img, .book_img img { width: 100%; height: 100%; object-fit: cover; }
        .crew_tag { font-size: 0.8em; background-color: #5dade2; color: white; padding: 2px 6px; border-radius: 4px; margin-bottom: 5px; }
        .crew_name { font-size: 0.9em; color: #333; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .no-content { width: 100%; text-align: center; color: #777; padding: 20px 0; }
        .box_side { width: 100%; text-align: right; padding-top: 5px; }
        .book_one_title { font-size: 0.9em; margin-top: 5px; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- 모달 스타일 (home.html 스타일과 통합) --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }
        .modal-content {
            background-color: var(--main-color-light);
            margin: 10% auto;
            padding: 20px;
            border: 2px solid var(--main-color-middle);
            width: 80%;
            max-width: 768px;
            border-radius: var(--border-middle);
            position: relative;
            font-family: 'GowunBatang-Regular';
            animation-name: animatetop;
            animation-duration: 0.4s;
        }
        @keyframes animatetop {
            from { top: -300px; opacity: 0 }
            to { top: 0; opacity: 1 }
        }
        .close-button {
            width: 35px;
            height: 35px;
            border-radius: var(--border-circle);
            background: var(--assist-color-middle);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: var(--font-size-2);
        }
        .close-button:hover {
            background: var(--assist-color-dark);
        }
        .modal-title {
            font-size: var(--font-size-1);
            font-weight: bold;
            color: var(--main-color-dark);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--main-color-middle);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        .modal-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border-radius: var(--border-middle);
            border: 1px solid var(--main-color-middle);
        }
        .modal-item:last-child {
            margin-bottom: 0;
        }
        .modal-item img {
            width: 60px;
            height: 85px;
            object-fit: cover;
            margin-right: 15px;
            border-radius: var(--border-middle);
            background-color: var(--main-color-light);
        }
        .modal-item-info {
            flex-grow: 1;
        }
        .modal-item-title {
            font-size: var(--font-size-2);
            font-weight: bold;
            color: var(--main-color-dark);
            margin-bottom: 5px;
        }
        .modal-item-sub {
            font-size: var(--font-size-3);
            color: var(--cancle-color-dark);
        }
        .loader {
            border: 5px solid var(--main-color-light);
            border-top: 5px solid var(--main-color-middle);
            border-radius: var(--border-circle);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* --- 그룹 모달 책 목록 스타일 (list.html 기반, mypage.html 스타일 적용) --- */
        .modal-book-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            padding: 0;
        }
        .modal-book-item {
            background-color: white;
            border: 1px solid var(--main-color-middle);
            border-radius: var(--border-middle);
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: calc(25% - 12px); /* 4개씩 배치 */
            box-sizing: border-box;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
            min-height: 150px;
        }
        .modal-book-item:hover {
            transform: translateY(-2px);
        }
        .modal-book-item img {
            width: 60px;
            height: 85px;
            object-fit: cover;
            border-radius: var(--border-middle);
            margin-bottom: 8px;
            background-color: var(--main-color-light);
        }
        .modal-book-item span {
            font-size: var(--font-size-3);
            color: var(--main-color-dark);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 2.4em;
            line-height: 1.2em;
        }
        .modal-loading, .modal-no-books {
            text-align: center;
            color: var(--cancle-color-dark);
            margin-top: 20px;
            font-size: var(--font-size-2);
            padding: 20px 0;
        }
    </style>
    <title> BookDuck²::My Page </title>
</head>
<body>
<div th:replace="~{fragments/therdHeader :: bodyHeader}" ></div>

<div class="container">
    <!-- 프로필 정보 -->
    <div class="profile_img_box">
        <div class="profile_img">
            <img th:src="${(loginuser != null and loginuser.img != null and !loginuser.img.isEmpty()) ? '/image/getimg?fileName=' + #uris.escapePath(loginuser.img) : '/img/bookduck_login.png'}"
                 alt="Profile Image" id="userProfileImage"
                 onerror="this.onerror=null; this.src='/img/bookduck_login.png';">
            <img id="useroriginimg" src="/img/bookduck_login.png" alt="Profile Image">
            <img src="/img/bookduck_login.png" alt="Profile Image">
            <input type="hidden" id="originImg" th:value="${session.loginuser.img}">
        </div>
        <div class="btn_circle yellow fix" onclick="location.href='/userupdate'">
            <i class="fa-solid fa-pen icon_white"></i>
        </div>
    </div>
    <div class="nickname dark_blue2" th:text="${loginuser.nickName} + '님'">닉네임님</div>

    <!-- MY CREW 섹션 -->
    <div class="my_crew box light_blue">
        <div class="title dark_blue2">MY CREW<div class="line_long dark_blue1"></div></div>
        <div class="box_temp">
            <!-- 그룹 목록 미리보기 (엔티티 포함 DTO 기준 접근) -->
            <div class="crew_list" th:if="${not #lists.isEmpty(myGroupsPreview)}">
                <div class="crew_one" th:each="groupView : ${myGroupsPreview}" th:data-group-id="${groupView.group.id}">
                    <div class="crew_book_img">
                        <!-- 그룹 대표 이미지 (Lazy 로딩 주의!) -->
                        <img th:src="${(groupView.group != null and not #lists.isEmpty(groupView.group.books) and groupView.group.books[0].book != null) ? groupView.group.books[0].book.cover : '/img/default_crew_icon.png'}"
                             alt="Crew Image" src="/img/default_crew_icon.png"
                             onerror="this.onerror=null; this.src='/img/default_crew_icon.png';">
                    </div>
                    <div class="crew_tag">CREW</div>
                    <!-- 그룹 이름 (groupView.group.name 사용) -->
                    <div class="crew_name" th:text="${groupView.group?.name ?: '이름 없음'}" th:title="${groupView.group?.name}">그룹 이름</div>
                </div>
            </div>
            <div class="no-content" th:if="${#lists.isEmpty(myGroupsPreview)}">
                <p>가입한 그룹이 없습니다.</p>
            </div>

            <!-- 그룹 더보기 버튼: 페이지 이동 -->
            <div class="box_side" th:if="${hasMoreGroups}">
                <button class="more btn_mini blue" onclick="location.href='/group/list'">더보기</button>
            </div>
        </div>
    </div>

    <!-- MY BOOK 섹션 -->
    <div class="my_book box light_yellow">
        <div class="title dark_yellow2">MY BOOK<div class="line_long dark_yellow1"></div></div>
        <div class="box_temp">
            <!-- 책 목록 미리보기 -->
            <div class="book_list" th:if="${not #lists.isEmpty(myBooksPreview)}">
                <div class="book_one" th:each="book : ${myBooksPreview}">
                    <div class="book_img">
                        <img th:src="${book.cover}" th:alt="${book.title}" src="/img/default_book_cover.png" onerror="this.onerror=null; this.src='/img/default_book_cover.png';">
                    </div>
                    <div class="book_one_title" th:title="${book.title}"></div>
                </div>
            </div>
            <div class="no-content" th:if="${#lists.isEmpty(myBooksPreview)}">
                <p>내 서재에 등록된 책이 없습니다.</p>
            </div>

            <!-- 책 더보기 버튼: 모달 호출 -->
            <div class="box_side" th:if="${hasMoreBooks}">
                <button class="more btn_mini yellow" onclick="openModal('book')">더보기</button>
            </div>
        </div>
    </div>

    <!-- 로그아웃 버튼 -->
    <button class="logout btn_long yellow" onclick="location.href='/logout'">LOGOUT</button>
</div>

<!-- ======================= 모달 창 구조 ======================= -->

<!-- 책 목록 모달 -->
<div id="bookModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('bookModal')">×</span>
        <h3 class="modal-title">내 서재</h3>
        <div id="bookListContainer" class="modal-list">
            <!-- 책 목록이 여기에 동적으로 삽입됩니다 -->
            <div class="loader" style="display: none;"></div> <!-- 로딩 스피너 -->
        </div>
    </div>
</div>

<!-- 그룹 책 목록 모달 -->
<div id="groupModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('groupModal')">×</span>
        <h3 class="modal-title" id="groupModalTitle">그룹 도서 목록</h3>
        <div id="groupListContainer" class="modal-list">
            <!-- 책 목록이 여기에 동적으로 삽입됩니다 -->
            <div class="loader" style="display: none;"></div> <!-- 로딩 스피너 -->
        </div>
    </div>
</div>

<!-- ======================= JavaScript ======================= -->
<script>
    // 모달 열기 함수 (책 및 그룹 공용)
    function openModal(type, groupId, groupName) {
        let modalId, listContainerId, apiUrl, title;

        if (type === 'book') {
            modalId = 'bookModal';
            listContainerId = 'bookListContainer';
            apiUrl = '/api/my-books';
            title = '내 서재';
        } else if (type === 'group') {
            modalId = 'groupModal';
            listContainerId = 'groupListContainer';
            apiUrl = `/group/api/group/${groupId}/books`;
            title = `${groupName || '그룹'} 도서 목록`;
        } else {
            console.error('Unsupported modal type:', type);
            return;
        }

        const modal = document.getElementById(modalId);
        const listContainer = document.getElementById(listContainerId);
        const modalTitle = modal.querySelector('.modal-title');
        let loader = listContainer.querySelector('.loader');
        if (!loader) {
            loader = document.createElement('div');
            loader.className = 'loader';
            listContainer.appendChild(loader);
        }

        Array.from(listContainer.children).forEach(child => {
            if (!child.classList.contains('loader')) {
                listContainer.removeChild(child);
            }
        });
        loader.style.display = 'block';
        modalTitle.textContent = title;
        modal.style.display = 'block';

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || '데이터를 불러오는데 실패했습니다.') });
                }
                return response.json();
            })
            .then(data => {
                loader.style.display = 'none';

                if (!data || data.length === 0) {
                    listContainer.innerHTML = '<div class="modal-no-books">등록된 도서가 없습니다.</div>';
                    return;
                }

                renderModalBookList(data, listContainer);
            })
            .catch(error => {
                console.error(`Error fetching ${type} data:`, error);
                loader.style.display = 'none';
                Array.from(listContainer.children).forEach(child => {
                    if (!child.classList.contains('loader')) {
                        listContainer.removeChild(child);
                    }
                });
                listContainer.innerHTML = `<div class="modal-no-books">${error.message || '오류가 발생했습니다.'}</div>`;
            });
    }

    // 모달 닫기 함수
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            const listContainer = modal.querySelector('.modal-list');
            if (listContainer) {
                Array.from(listContainer.children).forEach(child => {
                    if (!child.classList.contains('loader')) {
                        listContainer.removeChild(child);
                    }
                });
                const loader = listContainer.querySelector('.loader');
                if (loader) loader.style.display = 'none';
            }
        }
    }

    // 모달 외부 클릭 시 닫기
    window.onclick = function(event) {
        const bookModal = document.getElementById('bookModal');
        const groupModal = document.getElementById('groupModal');
        if (event.target === bookModal) {
            closeModal('bookModal');
        } else if (event.target === groupModal) {
            closeModal('groupModal');
        }
    }

    // 그룹 책 목록 렌더링 함수 (list.html 기반)
    function renderModalBookList(books, listContainer) {
        if (!listContainer) return;

        if (!books || books.length === 0) {
            listContainer.innerHTML = '<div class="modal-no-books">등록된 그룹 도서가 없습니다.</div>';
            return;
        }

        const ul = document.createElement('ul');
        ul.className = 'modal-book-list';

        books.forEach(book => {
            const li = document.createElement('li');
            li.className = 'modal-book-item';

            const img = document.createElement('img');
            img.src = book.cover ? book.cover : '/img/default_book_cover.png';
            img.alt = book.title || '책 표지';

            const span = document.createElement('span');
            span.textContent = book.title || '제목 없음';
            span.title = book.title || '';

            li.appendChild(img);
            li.appendChild(span);
            ul.appendChild(li);
        });

        Array.from(listContainer.children).forEach(child => {
            if (!child.classList.contains('loader')) {
                listContainer.removeChild(child);
            }
        });
        listContainer.appendChild(ul);
    }

    // 그룹 클릭 이벤트 리스너
    const crewList = document.querySelector('.crew_list');
    if (crewList) {
        crewList.addEventListener('click', function(event) {
            const crewItem = event.target.closest('.crew_one');
            if (!crewItem) return;

            const groupId = crewItem.dataset.groupId;
            const groupName = crewItem.querySelector('.crew_name')?.textContent || '그룹';
            if (groupId) {
                openModal('group', groupId, groupName);
            }
        });
    }
</script>

<script src="https://code.jquery.com/jquery-3.6.3.js"></script>
<script>
    const originImg = document.getElementById('originImg').value;

    if (originImg.length != 0) {
        // 이미지 URL 설정
        $('#useroriginimg')
            .attr("src", "/image/getimg?fileName=" + encodeURIComponent(originImg))
            .on("load", function () {
                //console.log("Image loaded successfully: " + originImg);
            })
            .on("error", function () {
                console.log("Image failed to load: " + originImg);
                $(this).attr("src", "/img/bookduck_login.png");
            });
    } else {
        $('#useroriginimg').attr("src", "/img/bookduck_login.png"); // 기본 이미지 설정
    }
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93c66c908c7eb0bd',t:'MTc0NjY4MDc0Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93c69c4798f67bcf',t:'MTc0NjY4MjcwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>