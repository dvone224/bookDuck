<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/member/joinForm.css">
    <script src="https://kit.fontawesome.com/116a85af51.js" crossorigin="anonymous"></script>
    <style></style>
    <title> BookDuck²::회원가입 </title>
</head>
<body>
<div th:replace="~{fragments/therdHeader :: bodyHeader}" ></div>
<div class="container">
<div class="logo dark_blue2" onclick="location.href='/home'">BookDuck²</div>
<div class="form_box">
    <form id="userjoinform" action="/user" method="post">
        <label for="joinId"></label>
        <input type="text" class="input_long blue_line" id="joinId" name="id" placeholder="ID(4~15자리 영소문자, 숫자)" required autocomplete="off">
        <div id="check validId"></div>

        <label for="joinPw"></label>
        <input type="text" class="input_long blue_line" id="joinPw" name="pw" placeholder="PASSWORD(영문 대/소문자, 숫자, 특수문자)" required autocomplete="off">
        <div id="check validPw"></div>

        <label for="joinNickname"></label>
        <input type="text" class="input_long blue_line" id="joinNickname" name="nickName" placeholder="닉네임(2~7자, 한글, 대/소문자, 숫자)" required autocomplete="off">
        <div id="check validNickname"></div>

        <div class="seperate">
            <div class="seperate_one">
                <label for="joinEmail"></label>
                <input type="text" class="input_long blue_line" id="joinEmail" name="email" placeholder="E-mail" required autocomplete="off">
            </div>
            <div class="seperate_two">
                <input type="button" class="btn_long blue" onclick="sendEmail()" value="인증하기">
            </div>
        </div>
        <div id="check validEmail"></div>

        <div class="seperate">
            <div class="seperate_one">
                <label for="joinEmail"></label>
                <input type="text" class="input_long blue_line" id="joinCode" name="verifyCode" placeholder="인증번호를 입력하세요" required autocomplete="off">
            </div>
            <div class="seperate_two">
                <input type="button" class="btn_long blue" onclick="checkCode()" value="인증완료">
            </div>
        </div>
        <div id="check validCode"></div>

        <div class="input_img">
            <div class="profile_img"> <img id="uploadImg" src="/img/bookduck_login.png" alt="기본이미지"> </div>
            <input type="file" id="userImg" name="userImg" accept="image/*">
            <input type="hidden" id="img" name="img">
            <input type="button" class="btn_long yellow" id="imgUploadBtn" value="프로필 이미지 등록">
            <div id="imgUploadErr"></div>
        </div>
        <div class="box">
            <div class="agree dark_blue2">
                <input type="checkbox" id="agree">
                <label for="agree"></label>개인정보 수집 및 이용 동의(필수)
                <button class="btn_mini blue" onclick="">약관보기</button>
            </div>
        </div>

        <div id="check validTotal"></div>
        <div class="box">
            <button type="submit" class="btn_long blue">가입하기</button>
        </div>
    </form>
</div>
</div>
</body>
</html>

<script src="https://code.jquery.com/jquery-3.6.3.js"></script>
<script>
    $("#imgUploadBtn").click(()=>{
        //파일데이터 추출
        var file=$("#userImg");
        console.log(file[0]);//순수한 태그
        console.dir(file[0].files[0]); //파일데이터

        //폼태그로 추가
        var formData = new FormData(); //폼객체
        formData.append("file",file[0].files[0]); //name, 값

        $.ajax({
            url:"user/imgupload",
            type:"post",
            data:formData, //보내는데이터 form
            contentType:false, //보내는데이터타입 false->"multipart/form-data"로 선언됩니다.
            processData:false, //폼데이터가 name=값&name=값 형식으로 자동변경되는 것을 막아줍니다.
            success:(result)=>{
                var res = result.split('/')[0];
                var imgname = result.split('/')[1];
                //var imgPath = "'"+img+"'";
                console.log(res);
                console.log(imgname);
                if(res == "success"){
                    alert("업로드가 완료되었습니다.");
                    $('#uploadImg').attr("src", "/image/getimg?fileName="+imgname);
                    $('#img').attr("value",imgname);
                }
            },
            error:(err)=>{
                $('#imgUploadErr').innerHTML="이미지 업로드 오류"
                //alert("업로드 에러발생");
            }

        })
    })

    const joinId = document.getElementById("joinId");
    const joinPw = document.getElementById("joinPw");
    const joinNickname = document.getElementById("joinNickname");
    const joinEmail = document.getElementById("joinEmail");
    const joinCode = document.getElementById("joinCode");

    let validId = false;
    let validPw = false;
    let validEmail = false;
    let validNickname = false;
    let validCode = false;

    let useableEmail = false;

    const submitFrom = document.getElementById("userjoinform");
    const agree = document.getElementById("agree")

    submitFrom.addEventListener("submit",(event)=>{
        event.preventDefault();
        const totalErr = document.getElementById("check validTotal");

        if(!validId){
            totalErr.innerHTML= "유효하지 않은 아이디 입니다."
            return;
        }
        if(!validPw){
            totalErr.innerHTML= "유효하지 않은 비밀번호 입니다."
            return;
        }
        if(!validNickname){
            totalErr.innerHTML= "유효하지 않은 별명 입니다."
            return;
        }
        if(!useableEmail){
            totalErr.innerHTML= "이메일 검증이 필요합니다."
            return;
        }
        if(!agree.checked){
            totalErr.innerHTML= "약관에 대한 동의가 필요합니다."
            return;
        }

        submitFrom.submit();
    })


    joinId.addEventListener("keyup",()=>{
        validId = false;
        const idErr = document.getElementById("check validId");
        let idValue = joinId.value;
        if(idValue == "") {
            idErr.innerHTML = "";
            return;
        }

        if(checkidlength(idValue) === true && checkidtext(idValue) === true){
            idErr.innerHTML = "";
        }else{
            idErr.innerHTML = "ID(4~15자리 영소문자, 숫자)";
            return;
        }

        fetch(`/user/searchusernickname?nickname=${encodeURIComponent(idValue)}`, {
            method: 'GET'
        })
            .then((response) => {
                if (response.ok) {
                    validId = true;
                    console.log(validId);

                }else{
                    idErr.innerHTML = "이미 사용중인 아이디입니다.";
                    console.log(validId);
                }
            })
            .catch((error) => {
                console.error("검색 중 오류 발생:", error);
            });

    })


    function checkidlength(id){
        return id.length >=4 && id.length<=15;
    }

    function checkidtext(id){
        return /^[a-z0-9][a-z0-9]*$/.test(id);
    }

    joinPw.addEventListener("keyup", ()=>{
        validPw = false;
        let pwErr= document.getElementById("check validPw")
        let pwValue = joinPw.value;
        if(pwTextCheck(pwValue)){
            pwErr.innerHTML = "";
        }else{
            pwErr.innerHTML = "PASSWORD(영문 대/소문자, 숫자, 특수문자(사용가능 특수문자: @ $ ! % * # ? &))"
            return;
        }

        validPw = true;

    })

    function pwTextCheck(pw){
        return /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/.test(pw);
    }

    joinNickname.addEventListener("keyup", ()=> {
        validNickname = false;
        const nicknameErr = document.getElementById("check validNickname");
        let nicknameValue = joinNickname.value;
        if(nicknameValue == "") {
            nicknameErr.innerHTML = "";
            return;
        }

        if(checknicknamelength(nicknameValue) === true && checknicknametext(nicknameValue) === true){
            nicknameErr.innerHTML = "";
        }else{
            nicknameErr.innerHTML = "닉네임(2~7자, 한글, 대/소문자, 숫자)";
            return;
        }

        fetch(`/user/searchusernickname?nickname=${encodeURIComponent(nicknameValue)}`, {
            method: 'GET'
        })
            .then((response) => {
                if (response.ok) {
                    validNickname = true;
                    console.log(validNickname);

                }else{
                    nicknameErr.innerHTML = "이미 사용중인 별명입니다.";
                    console.log(validNickname);
                }
            })
            .catch((error) => {
                console.error("검색 중 오류 발생:", error);
            });
    })

    function checknicknamelength(nickname){
        return nickname.length >=2 && nickname.length<=7;
    }

    function checknicknametext(nickname){
        return /^[ㄱ-ㅎ가-힣a-zA-Z0-9][ㄱ-ㅎ가-힣a-zA-Z0-9]*$/.test(nickname);
    }

    joinEmail.addEventListener("keyup", ()=> {
        validEmail = false;
        validCode = false;
        useableEmail = false;

        const emailErr = document.getElementById("check validEmail");
        let emailValue = joinEmail.value;
        if(emailValue == "") {
            emailErr.innerHTML = "";
            return;
        }

        if(checkemail(emailValue) === true){
            emailErr.innerHTML = "";
        }else{
            emailErr.innerHTML = "유효한 형식의 이메일이 아닙니다";
            return;
        }

        fetch(`/user/searchuseremail?email=${encodeURIComponent(emailValue)}`, {
            method: 'GET'
        })
            .then((response) => {
                if (response.ok) {
                    validEmail = true;
                    console.log(validEmail);

                }else{
                    emailErr.innerHTML = "이미 사용중인 이메일입니다.";
                    console.log(validEmail);
                }
            })
            .catch((error) => {
                console.error("검색 중 오류 발생:", error);
            });
    })

    function checkemail(email){
        return /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/.test(email);
    }

    function sendEmail(){
        const emailErr = document.getElementById("check validEmail");
        if(!validEmail){
            emailErr.innerHTML = "유효한 이메일이 아닙니다";
            return;
        }

        let formData = new FormData();
        formData.append('mail', joinEmail.value);

       fetch('/mailapi/sendmail',{
           method: 'POST',
           cache: 'no-cache',
           body: formData
       })
           .then((response) => response.json())
           .then((data) => {
               console.log(data);
           });
    }

    joinCode.addEventListener("keyup", ()=>{
        validCode = false;

        const codeErr = document.getElementById("check validCode");
        let codeValue = joinCode.value;
        if(codeValue == "") {
            codeErr.innerHTML = "";
            return;
        }

        if(checkcodetext(codeValue) === true && checkcodelength(codeValue) === true){
            codeErr.innerHTML = "";
        }else{
            codeErr.innerHTML = "인증코드는 6자리 숫자입니다.";
            return;
        }

        validCode = true;

    })

    function checkcodetext(code){
        return /^[0-9][0-9]*$/.test(code);
    }

    function checkcodelength(code){
        return code.length == 6;
    }


    function checkCode(){
        const codeErr = document.getElementById("check validCode");

        if(!validEmail){
            codeErr.innerHTML = "유효한 이메일이 아닙니다";
            return;
        }

        if(!validCode){
            codeErr.innerHTML = "유효한 인증번호가 아닙니다";
            return;
        }

        let formData = new FormData();
        formData.append('mail', joinEmail.value);
        formData.append('code', joinCode.value);

        fetch('/mailapi/verifycode',{
            method: 'POST',
            cache: 'no-cache',
            body: formData
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then((data) => {
                console.log(data);
                if (data.status === 'Verified') {
                    useableEmail = true;
                    codeErr.innerHTML = "이메일 인증에 성공하였습니다.";
                } else {
                    codeErr.innerHTML = "이메일 인증에 실패하였습니다.(인증번호의 유효시간은 30분 입니다.)";
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                codeErr.innerHTML = "인증 중 오류가 발생했습니다. 다시 시도하세요.";
            });

    }




</script>