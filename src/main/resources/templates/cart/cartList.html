<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Toss Payments SDK 로드 -->
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <!-- Font Awesome 로드 -->
    <script src="https://kit.fontawesome.com/116a85af51.js" crossorigin="anonymous"></script>
    <title> BookDuck²::CART </title>
    <style>
        /* 기본 스타일 리셋 */
        body, h2, h3, p, table, th, td, button, input, select, a {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "GowunBatang-Regular", sans-serif; /* 기본 글꼴 */
        }

        body {
            padding: 20px;
            max-width: 960px; /* 콘텐츠 최대 너비 */
            margin: auto;      /* 중앙 정렬 */
            background-color: #f8f9fa; /* 배경색 */
            color: #333;
            line-height: 1.6;
            font-size: 16px; /* 기본 폰트 크기 */
        }

        /* 페이지 제목 */
        .page-title {
            font-size: 1.8rem; /* 크기 조정 */
            font-weight: bold;
            margin-bottom: 25px; /* 간격 조정 */
            color: #2c3e50; /* 색상 변경 */
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        /* 오류 메시지 */
        .error-message {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 12px; /* 패딩 조정 */
            border-radius: 4px;
            margin-bottom: 20px; /* 간격 조정 */
            font-weight: bold;
            text-align: center;
        }

        /* 장바구니 비었을 때 메시지 */
        .empty-cart-message {
            text-align: center;
            padding: 40px 20px; /* 패딩 조정 */
            color: #6c757d; /* 색상 변경 */
            border: 1px dashed #ced4da; /* 테두리 변경 */
            margin-top: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .empty-cart-message p {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        .empty-cart-message a {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }
        .empty-cart-message a:hover {
            text-decoration: underline;
        }

        /* 장바구니 테이블 */
        #cart-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px; /* 간격 조정 */
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-radius: 5px;
            overflow: hidden; /* 테두리 둥글게 적용 */
            border: 1px solid #dee2e6; /* 테이블 전체 테두리 */
        }
        #cart-table th, #cart-table td {
            border-bottom: 1px solid #dee2e6; /* 행 구분선 */
            padding: 12px 15px; /* 패딩 조정 */
            text-align: left;
            vertical-align: middle;
            font-size: 0.95rem; /* 글꼴 크기 조정 */
        }
        #cart-table td { border-left: 1px solid #dee2e6; } /* 세로 구분선 */
        #cart-table td:first-child { border-left: none; } /* 첫번째 셀 왼쪽 테두리 제거 */
        #cart-table th { border-bottom-width: 2px; } /* 헤더 아래 구분선 강조 */

        #cart-table th {
            background-color: #f8f9fa; /* 헤더 배경색 */
            font-weight: bold;
            color: #495057;
        }
        /* 테이블 컬럼 너비 및 정렬 */
        .checkbox-col { width: 5%; text-align: center; }
        .image-col { width: 10%; padding-top: 15px; padding-bottom: 15px; } /* 이미지 여백 조정 */
        .price-col { width: 15%; text-align: right; }
        .action-col { width: 10%; text-align: center; }

        #cart-table td img {
            max-width: 60px;
            height: auto; /* 비율 유지 */
            display: block;
            margin-right: 10px; /* 이미지와 텍스트 간격 */
            border-radius: 3px; /* 이미지 모서리 */
            border: 1px solid #eee;
            background-color: #f0f0f0; /* 이미지 로딩 배경 */
        }
        #cart-table td a { color: #007bff; text-decoration: none; font-weight: bold; }
        #cart-table td a:hover { text-decoration: underline; }

        /* 버튼 기본 스타일 */
        button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            color: white;
            margin-left: 5px;
            transition: background-color 0.2s ease-in-out, opacity 0.2s ease-in-out;
            vertical-align: middle; /* 다른 요소와 수직 정렬 */
        }
        button:hover:not(:disabled) { opacity: 0.85; /* 호버 효과 변경 */ }
        button:disabled { background-color: #adb5bd; /* 비활성화 색상 변경 */ cursor: not-allowed; opacity: 0.6; }

        /* 삭제 버튼 */
        .remove-button { background-color: #dc3545; }
        .remove-button:hover:not(:disabled) { background-color: #c82333; }

        /* 결제 요약 */
        .cart-summary {
            border-top: 2px solid #dee2e6; /* 구분선 색상 */
            padding: 25px 0; /* 상하 패딩 조정 */
            margin-top: 20px;
            text-align: right;
        }
        .cart-summary h3 {
            margin-bottom: 20px; /* 버튼과의 간격 */
            font-size: 1.25rem; /* 크기 조정 */
            color: #495057;
        }
        .cart-summary span {
            font-weight: bold;
            color: #007bff; /* 총액 색상 */
            font-size: 1.3rem; /* 총액 글자 크기 */
            margin-left: 10px;
        }

        /* 결제하기 버튼 */
        #checkout-button {
            background-color: #007bff;
            padding: 12px 30px; /* 버튼 크기 조정 */
            font-size: 1rem;
            font-weight: bold;
        }
        #checkout-button:hover:not(:disabled) { background-color: #0056b3; }

        /* 체크박스 */
        .checkbox-col input[type="checkbox"] {
            cursor: pointer;
            width: 18px;  /* 크기 조정 */
            height: 18px; /* 크기 조정 */
            vertical-align: middle; /* 다른 내용과 수직 정렬 */
        }

    </style>
</head>
<body>
<!-- 헤더 프래그먼트 (Thymeleaf 사용 시) -->
<div th:replace="~{fragments/therdHeader :: bodyHeader}"></div>

<div class="page-title">
    <!-- 세션 정보가 있을 때와 없을 때 분기 처리 -->
    <span th:if="${session.loginuser}" th:text="${session.loginuser.nickName} + '님의 장바구니'">사용자 장바구니</span>
    <span th:unless="${session.loginuser}">장바구니</span>
</div>

<!-- 서버에서 전달된 오류 메시지 표시 -->
<div th:if="${errorMessage}" class="error-message" th:text="${errorMessage}"></div>

<!-- 장바구니 비었을 때 메시지 -->
<div id="empty-cart-msg-container" th:if="${cartItems == null or #lists.isEmpty(cartItems)}" class="empty-cart-message">
    <p>장바구니가 비어 있습니다.</p>
    <!-- 쇼핑 페이지 경로를 실제 프로젝트에 맞게 수정하세요 -->
    <a href="/shop/shopList">쇼핑 계속하기</a>
</div>

<!-- 장바구니 내용 (아이템이 있을 때만 표시) -->
<div id="cart-content-container" th:unless="${cartItems == null or #lists.isEmpty(cartItems)}">
    <table id="cart-table">
        <thead>
        <tr>
            <th class="checkbox-col"><input type="checkbox" id="select-all-items" title="전체 선택/해제"></th>
            <th class="image-col">상품 이미지</th>
            <th>상품명</th>
            <th class="price-col">가격</th>
            <th class="action-col">삭제</th>
        </tr>
        </thead>
        <tbody>
        <!-- 장바구니 아이템 반복 -->
        <tr th:each="item : ${cartItems}"
            th:data-bookid="${item.bookId}"
            th:data-price="${item.book?.price ?: 0}"
            th:data-title="${item.book?.title ?: '상품명 없음'}"
            class="cart-item-row">
            <td class="checkbox-col">
                <!-- 개별 상품 선택 체크박스 -->
                <input type="checkbox" class="item-checkbox" name="selectedItems" th:value="${item.bookId}">
            </td>
            <td class="image-col">
                <!-- 책 표지 이미지 (기본 이미지 및 오류 처리 포함) -->
                <img th:if="${item.book?.cover}" th:src="@{${item.book.cover}}" alt="Book Cover" onerror="this.onerror=null; this.src='/img/default_book_cover.png';"/>
                <span th:unless="${item.book?.cover}">이미지 없음</span>
            </td>
            <td>
                <!-- 책 제목 (링크 포함) -->
                <a th:if="${item.book}" class="item-title" th:href="@{/book/{bookId}(bookId=${item.book.id})}" th:text="${item.book.title}">책 제목</a>
                <span th:unless="${item.book}">상품 정보 없음</span>
                <!-- 필요시 저자 등 추가 정보 표시 -->
                <!-- <p th:if="${item.book}" th:text="${item.book.writer}"></p> -->
            </td>
            <td class="price-col">
                <!-- 책 가격 -->
                <span class="item-price" th:if="${item.book}" th:text="${#numbers.formatInteger(item.book.price, 0, 'COMMA')} + '원'">0원</span>
            </td>
            <td class="action-col">
                <!-- 삭제 버튼 -->
                <button type="button" class="remove-button"
                        th:data-userid="${item.userId}"
                        th:data-bookid="${item.bookId}">삭제</button>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- 결제 요약 -->
    <div class="cart-summary">
        <h3>선택 상품 금액: <span id="selected-total-amount-display">0원</span></h3>
        <button type="button" id="checkout-button" disabled>선택 상품 결제하기</button>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/

    // --- 요소 참조 ---
    const cartTableBody = document.querySelector('#cart-table tbody');
    const selectAllCheckbox = document.getElementById('select-all-items');
    // itemCheckboxes는 동적으로 변경될 수 있으므로 필요 시 다시 querySelectorAll 사용
    const selectedTotalAmountDisplay = document.getElementById('selected-total-amount-display');
    const checkoutButton = document.getElementById('checkout-button');
    const emptyCartMsgContainer = document.getElementById('empty-cart-msg-container');
    const cartContentContainer = document.getElementById('cart-content-container');

    // --- 현재 사용자 정보 ---
    const currentUser = /*[[${session.loginuser}]]*/ null;
    const currentUserId = currentUser ? currentUser.id : null;
    const currentUserNickName = currentUser ? currentUser.nickName : null;

    // --- Toss Payments SDK 관련 ---
    const clientKey = /*[[${'test_ck_ma60RZblrqomEqDaE0WM3wzYWBn1'}]]*/ null; // Thymeleaf로 키 주입 (보안상 더 나은 방법 고려)
    let tossPayments = null;

    // --- 함수 정의 ---

    /** 장바구니 아이템 삭제 */
    function removeCartItem(buttonElement, userId, bookId) {
        if (!confirm('정말로 이 상품을 장바구니에서 삭제하시겠습니까?')) return;
        if (!userId) { alert('사용자 정보가 없어 삭제할 수 없습니다.'); return; }

        buttonElement.disabled = true; buttonElement.textContent = '삭제 중...';

        fetch(`/cart/remove/${userId}/${bookId}`, { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    const rowToRemove = buttonElement.closest('tr');
                    if (rowToRemove) rowToRemove.remove();
                    updateSelectedTotalAmount();
                    checkIfCartIsEmpty();
                    alert('상품이 장바구니에서 삭제되었습니다.');
                } else {
                    return response.text().then(text => { throw new Error(text || '서버 오류'); }); // 오류 응답 처리
                }
            })
            .catch(error => {
                console.error('삭제 요청 오류:', error);
                alert(`삭제 실패: ${error.message}`);
                buttonElement.disabled = false; // 실패 시 버튼 복원
                buttonElement.textContent = '삭제';
            });
    }

    /** 선택된 상품 총액 업데이트 */
    function updateSelectedTotalAmount() {
        let newTotal = 0;
        let selectedCount = 0;
        // 체크박스를 다시 선택
        document.querySelectorAll('.item-checkbox:checked').forEach(checkbox => {
            const row = checkbox.closest('tr');
            const price = parseInt(row.dataset.price || '0', 10);
            if (!isNaN(price)) {
                newTotal += price;
                selectedCount++;
            }
        });

        if (selectedTotalAmountDisplay) {
            selectedTotalAmountDisplay.textContent = new Intl.NumberFormat('ko-KR').format(newTotal) + '원';
        }
        if (checkoutButton) {
            checkoutButton.disabled = selectedCount === 0; // 선택된 것이 없으면 비활성화
        }
        console.log("선택 총액 업데이트:", newTotal, "개수:", selectedCount);

        // 전체 선택 체크박스 상태 업데이트
        if (selectAllCheckbox) {
            const allItemCheckboxes = document.querySelectorAll('.item-checkbox'); // 현재 시점의 체크박스 다시 가져오기
            const allChecked = allItemCheckboxes.length > 0 && Array.from(allItemCheckboxes).every(cb => cb.checked);
            selectAllCheckbox.checked = allChecked;
        }
    }

    /** 장바구니 비었는지 확인 */
    function checkIfCartIsEmpty() {
        // 테이블 본문의 행 개수로 확인
        const hasItems = cartTableBody && cartTableBody.rows.length > 0;
        if (cartContentContainer) cartContentContainer.style.display = hasItems ? 'block' : 'none';
        if (emptyCartMsgContainer) emptyCartMsgContainer.style.display = hasItems ? 'none' : 'block';
    }

    // --- 이벤트 리스너 설정 ---

    /** DOM 로드 완료 후 실행 */
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM 로드 완료. 장바구니 스크립트 초기화 시작.");

        // Toss SDK 초기화
        if (clientKey && typeof TossPayments === 'function') {
            try {
                tossPayments = TossPayments(clientKey);
                console.log("Toss Payments SDK 초기화 완료.");
            } catch (sdkError) {
                console.error("Toss Payments SDK 초기화 오류:", sdkError);
                alert("결제 시스템 초기화 중 오류가 발생했습니다.");
                if(checkoutButton) checkoutButton.disabled = true; // SDK 없으면 결제 불가
            }
        } else {
            console.error("Toss Payments SDK 또는 Client Key가 없습니다.");
            if(checkoutButton) checkoutButton.disabled = true; // SDK 없으면 결제 불가
        }

        // 사용자 정보 확인
        if (!currentUserId || !currentUserNickName) {
            console.warn("사용자 정보 로드 실패. 로그인 상태를 확인하세요.");
            // 결제 버튼 비활성화 또는 로그인 안내
            if(checkoutButton) checkoutButton.disabled = true;
        } else {
            console.log("사용자 정보:", {currentUserId, currentUserNickName});
        }

        // 삭제 버튼 이벤트 리스너 (이벤트 위임 방식 고려 가능)
        document.querySelectorAll('.remove-button').forEach(button => {
            button.addEventListener('click', function() {
                const userId = this.dataset.userid;
                const bookId = this.dataset.bookid;
                if (userId && bookId) removeCartItem(this, userId, bookId);
                else console.error('삭제 버튼 데이터 속성 누락');
            });
        });

        // 개별 체크박스 이벤트 리스너
        document.querySelectorAll('.item-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedTotalAmount);
        });

        // 전체 선택 체크박스 이벤트 리스너
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = isChecked);
                updateSelectedTotalAmount();
            });
        }

        // 결제하기 버튼 이벤트 리스너
        if (checkoutButton) {
            checkoutButton.addEventListener('click', async function() {
                console.log("결제하기 버튼 클릭됨");

                if (!tossPayments) { alert("결제 시스템 준비 안됨"); return; }
                if (!currentUserId || !currentUserNickName) { alert("로그인 필요"); return; }
                if (checkoutButton.disabled) return;

                const selectedItems = [];
                document.querySelectorAll('.item-checkbox:checked').forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    selectedItems.push({
                        bookId: row.dataset.bookid,
                        title: row.dataset.title,
                        price: parseInt(row.dataset.price || '0', 10)
                    });
                });

                if (selectedItems.length === 0) { alert('결제 상품 선택 필요'); return; }
                console.log("결제 대상:", selectedItems);

                const totalAmount = selectedItems.reduce((sum, item) => sum + item.price, 0);
                if (isNaN(totalAmount) || totalAmount <= 0) { alert('결제 금액 오류'); return; }

                let orderName = selectedItems[0].title;
                if (selectedItems.length > 1) orderName += ` 외 ${selectedItems.length - 1}건`;
                if (orderName.length > 100) orderName = orderName.substring(0, 97) + "...";

                const orderId = `bookduck-cart-${currentUserId}-${Date.now()}`;
                const bookIdString = selectedItems.map(item => item.bookId).join(',');

                const baseUrl = window.location.origin;
                const successUrl = `${baseUrl}/payment/success?userId=${encodeURIComponent(currentUserId)}&orderId=${encodeURIComponent(orderId)}&amount=${totalAmount}&orderName=${encodeURIComponent(orderName)}&customerName=${encodeURIComponent(currentUserNickName)}&isbn=${encodeURIComponent(bookIdString)}`;
                const failUrl = `${baseUrl}/payment/fail?orderId=${encodeURIComponent(orderId)}`;

                checkoutButton.disabled = true; checkoutButton.textContent = '결제 준비 중...';

                const paymentParams = { amount: totalAmount, orderId, orderName, customerName: currentUserNickName, successUrl, failUrl };
                console.log("Toss 요청 파라미터:", paymentParams);

                try {
                    console.log("Toss Payments API 호출 시도...");
                    await tossPayments.requestPayment("카드", paymentParams);
                    console.log("Toss Payments API 호출 성공 (리다이렉션)");
                } catch (err) {
                    console.error("Toss Payments API 오류:", err);
                    checkoutButton.disabled = false; checkoutButton.textContent = '선택 상품 결제하기';
                    if (err.code !== "USER_CANCEL") { // 사용자가 취소한 경우는 제외하고 오류 알림
                        alert(`결제 오류:\n코드: ${err.code}\n메시지: ${err.message || '알 수 없음'}`);
                    } else {
                        console.log("사용자 결제 취소");
                    }
                }
            });
        } else {
            console.error("결제 버튼(#checkout-button) 없음");
        }

        // 초기 상태 설정
        updateSelectedTotalAmount();
        checkIfCartIsEmpty();
        console.log("장바구니 페이지 초기화 완료.");

    }); // DOMContentLoaded 끝

    /*]]>*/
</script>
</body>
</html>